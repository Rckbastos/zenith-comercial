<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Comercial - Admin Completo</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zenith">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D4AF37">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="zenith-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="pwa.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding-left: 0;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #D4AF37;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 60px;
            height: 60px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 0.25rem;
        }

        .header-title p {
            font-size: 0.95rem;
            color: #888;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(212, 175, 55, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #D4AF37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #0a0a0a;
        }

        .top-info-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #1a3a52 0%, #0a2a42 100%);
            border-bottom: 2px solid #D4AF37;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .top-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-info-label {
            color: #D4AF37;
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
        }

        .top-info-value {
            color: #fff;
            font-weight: 700;
            font-size: 1.15rem;
            white-space: nowrap;
        }

        .top-info-sep {
            height: 20px;
            width: 1px;
            background: #D4AF37;
        }

        /* Container */
        .container {
            width: 65%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        /* Navigation Tabs */
        .nav-tabs {
            width: 100%;
            max-width: 100%;
            margin: 0 auto 2rem auto;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0 1rem;
            box-sizing: border-box;
            background: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
            position: static;
            box-shadow: none;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #c8c8c8;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.08);
        }

        .nav-tab.active {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.12);
            border-bottom: 2px solid #D4AF37;
        }

        /* Content Sections */
        .content-section {
            display: none;
            width: 100%;
            padding: 0;
            margin: 0 auto;
        }

        .content-section.active {
            display: block;
        }

        /* Dashboard Section */
        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #D4AF37;
        }

        .dashboard-header p {
            color: #888;
            font-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #D4AF37;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #D4AF37;
        }

        .filter-btn:hover {
            border-color: #D4AF37;
            color: #0a0a0a;
            background: #D4AF37;
        }

        .filter-btn.active {
            background: #D4AF37;
            color: #0a0a0a;
            border-color: #D4AF37;
        }

        .date-filter {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border: 2px solid #D4AF37;
            border-radius: 6px;
            background: #0a0a0a;
            color: #fff;
            font-weight: 600;
        }

        .date-filter label {
            color: #D4AF37;
            font-size: 0.95rem;
        }

        .date-filter input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 0.95rem;
            outline: none;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            width: 100%;
            margin: 2rem 0;
        }

        .kpi-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            border-color: #D4AF37;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.1);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.95rem;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .kpi-icon.cost {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .kpi-icon.profit {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        .kpi-icon.orders {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .kpi-value.profit-color {
            color: #D4AF37;
        }

        .kpi-value.delta-positive {
            color: #10b981;
        }

        .kpi-value.delta-negative {
            color: #ef4444;
        }

        .kpi-subtitle {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 0.15rem;
            letter-spacing: 0.2px;
        }

        .kpi-card.remessa-highlight {
            border-color: #D4AF37;
            box-shadow: 0 8px 18px rgba(212, 175, 55, 0.15);
        }

        .kpi-icon.remessa-green {
            background: rgba(16, 185, 129, 0.12);
            color: #10b981;
        }

        .kpi-icon.remessa-blue {
            background: rgba(59, 130, 246, 0.12);
            color: #3b82f6;
        }

        .kpi-icon.remessa-gold {
            background: rgba(212, 175, 55, 0.15);
            color: #D4AF37;
        }

        .kpi-icon.remessa-purple {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #888;
        }

        /* Form Styles */
        .form-card,
        .form-card.wide-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin: 0 auto 2rem auto;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
            overflow-x: visible;
            overflow-y: visible;
        }


        .form-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #D4AF37;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 1rem;
            font-weight: 600;
            color: #ddd;
            margin-bottom: 0.25rem;
        }

        .form-group label span {
            color: #D4AF37;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.875rem 1rem;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #b8941f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .btn-success {
            background: #10b981;
            color: #0a0a0a;
        }

        .btn-success:hover {
            background: #0e9c75;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* ====================================
           TABELAS - BASE GERAL
           ==================================== */
        .data-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 1rem;
            overflow: visible;
            background: #0f0f0f;
            border-radius: 8px;
        }

        .data-table thead {
            background: rgba(212, 175, 55, 0.15);
        }

        .data-table th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 700;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #D4AF37;
            border-top: none;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            text-overflow: clip;
            box-sizing: border-box;
        }

        .data-table td {
            padding: 1rem 0.75rem;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 500;
            color: #ffffff;
            border-bottom: 1px solid #333;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            text-overflow: clip;
            box-sizing: border-box;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.08);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Texto longo em c√©lulas */
        .data-table td span[title] {
            display: inline-block;
            max-width: 100%;
            overflow: visible;
            text-overflow: clip;
            white-space: normal;
            vertical-align: middle;
        }

        .orders-table th.actions-col,
        .orders-table td.actions-col {
            text-align: center;
            white-space: nowrap;
        }

        .orders-table th.proof-col,
        .orders-table td.proof-col {
            text-align: center;
        }

        .proof-status {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            vertical-align: middle;
        }

        /* Container das tabelas */
        .form-card {
            width: 100%;
            max-width: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin: 0 auto 2rem auto;
            box-sizing: border-box;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
        }

        .form-card.wide-card {
            width: 100%;
            max-width: 100%;
            margin: 0 auto 2rem auto;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
        }

        /* Wrapper horizontal para tabelas largas */
        .table-scroll {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        /* Tabela base */
        .data-table {
            width: 100%;
            min-width: 0;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            font-size: 1rem;
            background: #0a0a0a;
            border-radius: 8px;
            overflow: visible;
        }

        .orders-table {
            min-width: 1800px;
            table-layout: fixed;
            width: 100%;
        }

        /* Larguras fixas por coluna nas tabelas de ordens */
        .orders-table th:nth-child(1),
        .orders-table td:nth-child(1) { width: 80px; }   /* ID */

        .orders-table th:nth-child(2),
        .orders-table td:nth-child(2) { width: 120px; }  /* Cliente */

        .orders-table th:nth-child(3),
        .orders-table td:nth-child(3) { width: 120px; }  /* Vendedor */

        .orders-table th:nth-child(4),
        .orders-table td:nth-child(4) { width: 140px; }  /* Servi√ßo */

        .orders-table th:nth-child(5),
        .orders-table td:nth-child(5) { width: 70px; }   /* Qtd */

        .orders-table th:nth-child(6),
        .orders-table td:nth-child(6) { width: 110px; }  /* Pre√ßo (un.) */

        .orders-table th:nth-child(7),
        .orders-table td:nth-child(7) { width: 200px; }  /* Wallet */

        .orders-table th:nth-child(8),
        .orders-table td:nth-child(8) { width: 110px; }  /* Venda */

        .orders-table th:nth-child(9),
        .orders-table td:nth-child(9) { width: 110px; }  /* Custo */

        .orders-table th:nth-child(10),
        .orders-table td:nth-child(10) { width: 110px; } /* Lucro */

        .orders-table th:nth-child(11),
        .orders-table td:nth-child(11) { width: 110px; } /* Comiss√£o */

        .orders-table th:nth-child(12),
        .orders-table td:nth-child(12) { width: 100px; } /* Data */

        .orders-table th:nth-child(13),
        .orders-table td:nth-child(13) { width: 100px; } /* Lan√ßamento */

        .orders-table th:nth-child(14),
        .orders-table td:nth-child(14) { width: 90px; text-align: center; } /* Status Comprovante */

        .orders-table th:nth-child(15),
        .orders-table td:nth-child(15) { width: 100px; text-align: center; } /* Comprovante */

        .orders-table th:nth-child(16),
        .orders-table td:nth-child(16) { width: 140px; } /* Trava */

        .orders-table th:nth-child(17),
        .orders-table td:nth-child(17) { width: 120px; text-align: center; } /* A√ß√µes/Status */

        /* Evita quebra de linha nas tabelas de ordens */
        .orders-table th,
        .orders-table td {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            word-break: normal !important;
            padding: 1rem 0.5rem !important;
        }

        .orders-table td span[title] {
            white-space: nowrap;
        }

        /* Cabe√ßalho da tabela */
        .data-table thead {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 1.25rem 1rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 700;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #D4AF37;
            white-space: normal;
            word-break: break-word;
            background: #1a1a1a;
            box-sizing: border-box;
        }

        /* C√©lulas da tabela */
        .data-table td {
            padding: 1.25rem 1rem;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 500;
            color: #ffffff;
            border-bottom: 1px solid #222;
            white-space: normal;
            word-break: break-word;
            background: #0a0a0a;
            box-sizing: border-box;
        }

        /* Hover nas linhas */
        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.08) !important;
        }

        .data-table tbody tr:hover td {
            background: rgba(212, 175, 55, 0.08) !important;
        }

        /* √öltima linha sem borda */
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mostrar texto completo */
        .data-table th,
        .data-table td {
            overflow: visible;
            text-overflow: clip;
        }

        /* Alinhamentos espec√≠ficos */
        .data-table td:has(.badge) {
            text-align: center;
        }

        .profit-color,
        .profit-value {
            color: #10b981 !important;
            font-weight: 600;
        }

        /* Bot√µes dentro das tabelas */
        .data-table .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .data-table .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .badge-pending {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .badge-gold {
            background: rgba(212, 175, 55, 0.15);
            color: #D4AF37;
            border: 1px solid rgba(212, 175, 55, 0.4);
        }

        /* Larguras m√≠nimas por coluna */
        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 80px;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            min-width: 140px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            min-width: 140px;
        }

        /* Wallet */
        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            min-width: 220px;
            word-break: break-all;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            min-width: 200px;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            min-width: 140px;
            text-align: center;
        }

        /* Responsividade */
        @media screen and (min-width: 1600px) {
            .container {
                width: 95%;
                max-width: 2400px;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 1600px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 1400px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
            .data-table {
                font-size: 0.9rem;
            }
            .data-table th {
                font-size: 0.8rem;
                padding: 1rem 0.75rem;
            }
            .data-table td {
                padding: 1rem 0.75rem;
            }
        }

        @media screen and (max-width: 1200px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                width: 100%;
                padding: 1rem 0.5rem;
            }
            .data-table {
                font-size: 0.85rem;
            }
            .data-table th,
            .data-table td {
                padding: 0.875rem 0.5rem;
            }
        }

        /* Backgrounds consolidados */
        .data-table thead tr {
            background: #1a1a1a !important;
        }

        .data-table tbody tr {
            background: #0a0a0a !important;
        }

        .data-table tbody tr:nth-child(even) {
            background: #0f0f0f !important;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 0.25rem;
            font-size: 1.15rem;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .btn-edit:hover {
            background: #3b82f6;
            color: #fff;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: #fff;
        }

        .btn:disabled,
        .btn-primary:disabled,
        .btn-secondary:disabled,
        .btn-success:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-trava {
            background: #f59e0b;
            color: #0a0a0a;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            transition: background 0.2s ease;
        }

        .btn-trava:hover {
            background: #d97706;
            color: #0a0a0a;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            backdrop-filter: blur(2px);
        }

        .modal-card {
            background: #0f0f0f;
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 1.75rem;
            width: min(900px, 94vw);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .modal-header h3 {
            color: #D4AF37;
        }

        .modal-close {
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: #D4AF37;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .modal-comprovante {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* Modo fullscreen do modal de comprovante */
        /* Lightbox para ampliar comprovante em tela cheia */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
        }

        .lightbox-close {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #D4AF37;
            color: #D4AF37;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10000;
        }

        .lightbox-close:hover {
            background: #D4AF37;
            color: #0a0a0a;
            transform: scale(1.1);
        }

        .lightbox-content {
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .lightbox-content embed {
            width: 90vw;
            height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-comprovante .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .comprovante-info {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #444;
        }

        .comprovante-info p {
            margin: 0;
            color: #ddd;
        }

        .comprovante-info strong {
            color: #D4AF37;
        }

        .comprovante-image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: #0a0a0a;
            border-radius: 8px;
            border: 2px solid #333;
            padding: 1rem;
        }

        .comprovante-image-container img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .comprovante-placeholder {
            color: #888;
            font-size: 1.1rem;
            text-align: center;
        }

        .modal-comprovante .modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #333;
            justify-content: flex-end;
        }

        /* Modal de Trava (hedge) */
        .hedge-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1300;
            backdrop-filter: blur(2px);
        }

        .hedge-modal {
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 520px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
            color: #f5f5f5;
            display: grid;
            gap: 1rem;
        }

        .hedge-modal h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: #D4AF37;
            font-size: 1.25rem;
        }

        .hedge-modal small {
            color: #9ca3af;
        }

        .hedge-modal p {
            margin: 0.2rem 0;
            line-height: 1.5;
        }

        .hedge-modal .form-group {
            margin-bottom: 1rem;
            gap: 0.35rem;
        }

        .hedge-modal .form-group input,
        .hedge-modal .form-group textarea {
            padding: 0.75rem 0.9rem;
        }

        .hedge-modal form {
            display: grid;
            gap: 0.85rem;
        }

        .modal-subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.65rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 0.75rem;
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #D4AF37;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #e5e7eb;
            font-weight: 600;
        }

        .info-box {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .info-box-icon {
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .info-box-text {
            font-size: 0.95rem;
            color: #D4AF37;
            line-height: 1.6;
        }

        @media screen and (max-width: 1400px) {
            .form-card.wide-card {
                width: 75%;
                max-width: 75%;
                height: auto;
                min-height: fit-content;
                max-height: none;
                overflow: visible;
            }
        }

        /* Responsividade */
        @media screen and (max-width: 1600px) {
            .container {
                width: 75%;
            }
        }

        @media screen and (max-width: 1400px) {
            .container {
                width: 85%;
            }
        }

        @media screen and (max-width: 1200px) {
            .container {
                width: 95%;
            }
        }

        @media screen and (max-width: 992px) {
            .container {
                width: 100%;
                padding: 1rem 0.5rem;
            }
            .nav-tabs {
                width: 100%;
            }
            .data-table {
                min-width: 0;
            }
            .orders-table {
                min-width: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            body {
                padding-left: 0;
            }

            .nav-tabs {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
                width: auto;
                box-shadow: none;
            }

            .nav-tab {
                padding: 0.65rem 1rem;
                font-size: 0.95rem;
            }

            .dashboard-header h2 {
                font-size: 1.5rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: scroll;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .btn,
            .btn-primary,
            .btn-secondary {
                padding: 0.75rem 1.25rem;
                font-size: 0.95rem;
            }

            .form-card {
                padding: 2rem;
            }

            .form-card h3 {
                font-size: 1.35rem;
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="top-info-bar">
        <div class="top-info-item">
            <span class="top-info-label">üí∞ D√≥lar:</span>
            <span id="topUsdtPrice" class="top-info-value">R$ --</span>
        </div>
    </div>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo">
                <img src="zenith-logo.png" alt="Zenith Logo">
            </div>
            <div class="header-title">
                <h1>Zenith Comercial</h1>
                <p>Sistema de Gest√£o Administrativo</p>
            </div>
        </div>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <span>Admin</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection(event, 'dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection(event, 'usuarios')">üë• Usu√°rios</button>
            <button class="nav-tab" onclick="showSection(event, 'servicos')">üõ†Ô∏è Servi√ßos</button>
            <button class="nav-tab" onclick="showSection(event, 'atribuir')">üîó Atribuir Servi√ßos</button>
            <button class="nav-tab" onclick="showSection(event, 'dolar')">üí± Cota√ß√£o D√≥lar</button>
            <button class="nav-tab" onclick="showSection(event, 'ordens-abertas')">üìã Ordens Abertas</button>
            <button class="nav-tab" onclick="showSection(event, 'ordens-concluidas')">‚úÖ Ordens Conclu√≠das</button>
            <button class="nav-tab" onclick="showSection(event, 'comissoes-pendentes')">üíµ Comiss√µes Pendentes</button>
            <button class="nav-tab" onclick="showSection(event, 'comissoes-pagas')">‚úÖ Comiss√µes Pagas</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="dashboard-header">
                <h2>Dashboard Financeiro</h2>
                <p>Vis√£o geral do desempenho comercial</p>
            </div>

            <div class="filter-buttons">
                <button class="filter-btn" data-period="all" onclick="setFilter('all')">Todas</button>
                <button class="filter-btn active" data-period="today" onclick="setFilter('today')">Hoje</button>
                <button class="filter-btn" data-period="week" onclick="setFilter('week')">Semanal</button>
                <button class="filter-btn" data-period="month" onclick="setFilter('month')">Mensal</button>
                <div class="date-filter">
                    <label for="filterDateInput">Data:</label>
                    <input type="date" id="filterDateInput" onchange="setFilter('date', this.value)">
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Custo Total</span>
                        <div class="kpi-icon cost">üí∞</div>
                    </div>
                    <div class="kpi-value" id="kpiCost">R$ 0,00</div>
                    <div class="kpi-trend">
                        <span>‚Üì</span>
                        <span>Despesas operacionais</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Lucro Total</span>
                        <div class="kpi-icon profit">üìà</div>
                    </div>
                    <div class="kpi-value profit-color" id="kpiProfit">R$ 0,00</div>
                    <div class="kpi-trend">
                        <span>‚Üë</span>
                        <span>Margem de lucro</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Ordens Abertas</span>
                        <div class="kpi-icon orders">üì¶</div>
                    </div>
                    <div class="kpi-value" id="kpiOpen">0</div>
                    <div class="kpi-trend">
                        <span>‚è≥</span>
                        <span>Aguardando conclus√£o</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Ordens Conclu√≠das</span>
                        <div class="kpi-icon orders">‚úÖ</div>
                    </div>
                    <div class="kpi-value" id="kpiClosed">0</div>
                    <div class="kpi-trend">
                        <span>‚Üë</span>
                        <span>Total processado</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <h3 style="color: #D4AF37; margin-bottom: 1rem; font-size: 1.25rem;">üìä Detalhamento Remessa</h3>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Remessa Lucro TX</span>
                            <div class="kpi-icon remessa-green">üí∞</div>
                        </div>
                        <div class="kpi-value" id="kpiRemessaLucroTx" style="color: #10b981;">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span>‚Üë</span>
                            <span>Spread 0.80% ‚Üí 1.20%</span>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Remessa Lucro Repasse</span>
                            <div class="kpi-icon remessa-blue">ü§ù</div>
                        </div>
                        <div class="kpi-value" id="kpiRemessaLucroRepasse" style="color: #3b82f6;">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span>‚Üë</span>
                            <span>50% divis√£o intermedi√°rio</span>
                        </div>
                    </div>

                    <div class="kpi-card remessa-highlight" style="border: 2px solid #D4AF37;">
                        <div class="kpi-header">
                            <span class="kpi-title">Lucro Total Remessa</span>
                            <div class="kpi-icon remessa-gold">üìà</div>
                        </div>
                        <div class="kpi-value" id="kpiRemessaLucroTotal" style="color: #D4AF37;">R$ 0,00</div>
                        <div class="kpi-trend">
                            <span>‚Üë</span>
                            <span>TX + Repasse</span>
                        </div>
                    </div>
                </div>
                <div id="remessaWarnings" style="display: none;"></div>
            </div>
        </div>

        <!-- Usu√°rios Section -->
        <div id="usuarios" class="content-section">
            <div class="form-card">
                <h3><span>üë§</span> Cadastrar Usu√°rio e Comiss√£o</h3>
                <form id="userForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Completo <span>*</span></label>
                            <input type="text" id="userName" placeholder="Ex: Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label>E-mail <span>*</span></label>
                            <input type="email" id="userEmail" placeholder="joao@zenith.com" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone <span>*</span></label>
                            <input type="tel" id="userPhone" placeholder="(11) 99999-9999" required autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label>Cargo <span>*</span></label>
                            <select id="userRole" required>
                                <option value="">Selecione...</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Gerente de Contas">Gerente de Contas</option>
                                <option value="Consultor Comercial">Consultor Comercial</option>
                                <option value="Executivo de Vendas">Executivo de Vendas</option>
                                <option value="Analista Comercial">Analista Comercial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Senha de acesso</label>
                            <input type="password" id="userPassword" placeholder="Defina a senha para login" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>Comiss√£o sobre Lucro (%) <span>*</span></label>
                            <input type="number" id="userCommission" placeholder="Ex: 15" min="0" max="100" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Status <span>*</span></label>
                            <select id="userStatus" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>Comiss√£o:</strong> Percentual calculado sobre o lucro l√≠quido de cada venda. 
                            Exemplo: Lucro R$ 1.000 com 15% = R$ 150 de comiss√£o.
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Usu√°rio</button>
                        <button type="reset" class="btn btn-secondary">üîÑ Limpar</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üë•</span> Usu√°rios Cadastrados</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Cargo</th>
                            <th>Comiss√£o</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Servi√ßos Section -->
        <div id="servicos" class="content-section">
            <div class="form-card">
                <h3><span>üõ†Ô∏è</span> Cadastrar Servi√ßo</h3>
                <form id="serviceForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Servi√ßo <span>*</span></label>
                        <input type="text" id="serviceName" placeholder="Ex: Consignado INSS" required>
                    </div>
                    <div class="form-group">
                        <label>Moeda <span>*</span></label>
                        <select id="serviceCurrency" required>
                            <option value="BRL" selected>BRL - Real (R$)</option>
                            <option value="USD">USD - D√≥lar ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Custo <span>*</span></label>
                        <select id="costType" required onchange="toggleCostFields()">
                            <option value="">Selecione...</option>
                            <option value="fixo">Fixo (valor)</option>
                            <option value="percentual">Percentual (%)</option>
                            <option value="fixo_percentual">Fixo + Percentual</option>
                            <option value="cotacao_percentual">Cota√ß√£o + Percentual</option>
                        </select>
                    </div>
                        <div class="form-group" id="costFixoGroup" style="display: none;">
                            <label>Custo Fixo (R$) <span>*</span></label>
                            <input type="number" id="costFixo" placeholder="Ex: 20" min="0" step="0.01">
                        </div>
                        <div class="form-group" id="costPercentualGroup" style="display: none;">
                            <label>Custo Percentual (%) <span>*</span></label>
                            <input type="number" id="costPercentual" placeholder="Ex: 0.80" min="0" max="100" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Status <span>*</span></label>
                            <select id="serviceStatus" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>Tipos de Custo:</strong><br>
                            ‚Ä¢ <strong>Fixo:</strong> Valor fixo em reais (Ex: R$ 20,00)<br>
                            ‚Ä¢ <strong>Percentual:</strong> Percentual sobre o valor da venda (Ex: 0.80%)<br>
                            ‚Ä¢ <strong>Fixo + Percentual:</strong> Combina√ß√£o dos dois (Ex: R$ 20,00 + 0.80%)<br>
                            ‚Ä¢ <strong>Cota√ß√£o + Percentual:</strong> Usa a cota√ß√£o USDT no momento e aplica o percentual informado
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="serviceDescription" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Servi√ßo</button>
                        <button type="reset" class="btn btn-secondary">üîÑ Limpar</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üì¶</span> Servi√ßos Cadastrados</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Servi√ßo</th>
                            <th>Custo</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Atribuir Servi√ßos Section -->
        <div id="atribuir" class="content-section">
            <div class="form-card">
                <h3><span>üîó</span> Atribuir Servi√ßos a Usu√°rios</h3>
                <form id="assignForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Selecionar Usu√°rio <span>*</span></label>
                            <select id="assignUser" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Selecionar Servi√ßo <span>*</span></label>
                            <select id="assignService" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">‚ÑπÔ∏è</span>
                        <div class="info-box-text">
                            Atribua os servi√ßos que cada usu√°rio pode vender. Isso permite controlar quais produtos cada membro do time comercial tem acesso.
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üîó Atribuir Servi√ßo</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üìã</span> Servi√ßos Atribu√≠dos</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usu√°rio</th>
                            <th>Cargo</th>
                            <th>Servi√ßos Atribu√≠dos</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="assignmentsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Cota√ß√£o D√≥lar Section -->
        <div id="dolar" class="content-section">
            <div class="form-card">
                <h3><span>üí±</span> Configurar Cota√ß√£o do D√≥lar</h3>
                <form id="dolarForm">
                    <div class="form-group">
                        <label>Link da API de Cota√ß√£o <span>*</span></label>
                        <input type="url" id="dolarAPI" placeholder="https://economia.awesomeapi.com.br/last/USD-BRL" required>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>APIs Sugeridas:</strong><br>
                            ‚Ä¢ AwesomeAPI: https://economia.awesomeapi.com.br/last/USD-BRL<br>
                            ‚Ä¢ BrasilAPI: https://brasilapi.com.br/api/v2/currency/USD<br>
                            ‚Ä¢ Banco Central: https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Configura√ß√£o</button>
                        <button type="button" class="btn btn-secondary" onclick="testDolarAPI()">üîç Testar API</button>
                    </div>
                </form>

                <div class="form-card" style="margin-top: 2rem;">
                    <h3><span>üìä</span> Cota√ß√£o Atual <button type="button" class="btn btn-primary" onclick="atualizarCotacao()" style="margin-left: 1rem; padding: 0.5rem 1rem;">üîÑ Atualizar</button></h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-title">USDT (Binance)</span>
                                <div class="kpi-icon profit">üí∞</div>
                            </div>
                            <div class="kpi-value profit-color" id="usdtPrice">R$ 5,54</div>
                            <div class="kpi-trend">
                                <span style="color: #10b981;">‚óè</span>
                                <span>Tempo real</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-title">√öltima Atualiza√ß√£o</span>
                                <div class="kpi-icon orders">üïê</div>
                            </div>
                            <div class="kpi-value" style="font-size: 1.5rem;" id="lastUpdate">--</div>
                            <div class="kpi-trend">
                                <span id="lastUpdateTime">--:--</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.875rem; margin-top: 1rem;">üí° Cota√ß√£o obtida diretamente da API p√∫blica da Binance (USDT/BRL)</p>
                </div>
            </div>
        </div>

        <!-- Ordens Abertas Section -->
        <div id="ordens-abertas" class="content-section">
            <div class="form-card wide-card">
                <h3><span>üìã</span> Ordens de Pagamento em Aberto</h3>
                <div class="table-scroll">
                <table class="data-table orders-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Servi√ßo</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Lan√ßamento</th>
                            <th>Status Comprovante</th>
                            <th class="proof-col">Comprovante</th>
                            <th>Trava</th>
                            <th class="actions-col">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="openOrdersTbody"></tbody>
                </table>
                </div>
            </div>
        </div>

        <!-- Ordens Conclu√≠das Section -->
        <div id="ordens-concluidas" class="content-section">
            <div class="form-card wide-card">
                <h3><span>‚úÖ</span> Ordens de Pagamento Conclu√≠das</h3>
                <div class="filter-buttons" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <label for="serviceFilterConcluded" style="color: #D4AF37; font-weight: 600; white-space: nowrap;">Filtrar por Servi√ßo:</label>
                    <select id="serviceFilterConcluded" class="form-control" style="min-width: 250px; padding: 0.75rem 1rem; background: #0a0a0a; border: 2px solid #D4AF37; border-radius: 6px; color: #fff; font-size: 1rem;" onchange="filterConcludedOrdersByService()">
                        <option value="all">Todos os Servi√ßos</option>
                    </select>
                </div>
                <div class="table-scroll">
                <table class="data-table orders-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Servi√ßo</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Lan√ßamento</th>
                            <th>Status Comprovante</th>
                            <th class="proof-col">Comprovante</th>
                            <th>Trava</th>
                            <th class="actions-col">Status</th>
                        </tr>
                    </thead>
                    <tbody id="concludedOrdersTbody"></tbody>
                </table>
                </div>
            </div>
        </div>
        <!-- Comiss√µes Pendentes Section -->
        <div id="comissoes-pendentes" class="content-section">
            <div class="form-card">
                <h3><span>üíµ</span> Comiss√µes Pendentes de Pagamento</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vendedor</th>
                            <th>Cargo</th>
                            <th>Total de Vendas</th>
                            <th>Lucro Gerado</th>
                            <th>Taxa</th>
                            <th>Comiss√£o a Pagar</th>
                            <th>Data</th>
                            <th>Per√≠odo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="pendingCommissionsTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Comiss√µes Pagas Section -->
        <div id="comissoes-pagas" class="content-section">
            <div class="form-card">
                <h3><span>‚úÖ</span> Comiss√µes Pagas</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vendedor</th>
                            <th>Cargo</th>
                            <th>Total de Vendas</th>
                            <th>Lucro Gerado</th>
                            <th>Taxa</th>
                            <th>Comiss√£o Paga</th>
                            <th>Per√≠odo</th>
                            <th>Data Pagamento</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="paidCommissionsTbody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modal de Edi√ß√£o de Usu√°rio -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Usu√°rio</h3>
                <button type="button" class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome completo <span>*</span></label>
                        <input type="text" id="editUserName" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail <span>*</span></label>
                        <input type="email" id="editUserEmail" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Telefone <span>*</span></label>
                        <input type="tel" id="editUserPhone" required autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label>Cargo <span>*</span></label>
                        <select id="editUserRole" required>
                            <option value="">Selecione...</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Gerente de Contas">Gerente de Contas</option>
                            <option value="Consultor Comercial">Consultor Comercial</option>
                            <option value="Executivo de Vendas">Executivo de Vendas</option>
                            <option value="Analista Comercial">Analista Comercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nova Senha</label>
                        <input type="password" id="editUserPassword" placeholder="Deixe em branco para manter" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Comiss√£o sobre Lucro (%) <span>*</span></label>
                        <input type="number" id="editUserCommission" placeholder="Ex: 15" min="0" max="100" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>Status <span>*</span></label>
                        <select id="editUserStatus" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 1rem;">
                    <span class="info-box-icon">‚ÑπÔ∏è</span>
                    <div class="info-box-text">
                        Atualize a senha apenas se desejar troc√°-la. Os demais campos tamb√©m sincronizam o login desse usu√°rio.
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Servi√ßo -->
    <div id="editServiceModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üõ†Ô∏è Editar Servi√ßo</h3>
                <button type="button" class="modal-close" onclick="closeEditServiceModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Atualize dados, moeda, custos e status do servi√ßo.</div>
            <form id="editServiceForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Servi√ßo <span>*</span></label>
                        <input type="text" id="editServiceName" required>
                    </div>
                    <div class="form-group">
                        <label>Moeda <span>*</span></label>
                        <select id="editServiceCurrency" required>
                            <option value="BRL">BRL - Real (R$)</option>
                            <option value="USD">USD - D√≥lar ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Custo <span>*</span></label>
                        <select id="editCostType" required onchange="toggleCostFieldsEdit()">
                            <option value="">Selecione...</option>
                            <option value="fixo">Fixo (valor)</option>
                            <option value="percentual">Percentual (%)</option>
                            <option value="fixo_percentual">Fixo + Percentual</option>
                            <option value="cotacao_percentual">Cota√ß√£o + Percentual</option>
                        </select>
                    </div>
                    <div class="form-group" id="editCostFixoGroup" style="display: none;">
                        <label>Custo Fixo</label>
                        <input type="number" id="editCostFixo" placeholder="Ex: 25" min="0" step="0.01">
                    </div>
                    <div class="form-group" id="editCostPercentualGroup" style="display: none;">
                        <label>Custo Percentual (%)</label>
                        <input type="number" id="editCostPercentual" placeholder="Ex: 0.8" min="0" max="100" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Status <span>*</span></label>
                        <select id="editServiceStatus" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="editServiceDescription" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditServiceModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Atribui√ß√µes -->
    <div id="editAssignmentsModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üîó Atribuir Servi√ßos ao Usu√°rio</h3>
                <button type="button" class="modal-close" onclick="closeEditAssignmentsModal()">&times;</button>
            </div>
            <div class="modal-subtitle" id="editAssignmentsUserInfo">Selecione os servi√ßos que este usu√°rio poder√° vender.</div>
            <form id="editAssignmentsForm">
                <div class="form-group">
                    <label>Servi√ßos dispon√≠veis</label>
                    <div id="assignServiceList" class="checkbox-list"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditAssignmentsModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Atribui√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Comprovante -->
    <!-- Modal de Comprovante -->
    <div id="comprovanteModal" class="modal-overlay" style="display: none;" onclick="fecharModal()">
        <div class="modal-card modal-comprovante" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üìé Comprovante de Pagamento</h3>
                <button type="button" class="modal-close" onclick="fecharModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="comprovante-info">
                    <p><strong>Wallet:</strong> <span id="walletInfo">-</span></p>
                </div>
                <div class="comprovante-image-container">
                    <img id="comprovanteImg" src="" alt="Comprovante" style="display: none;">
                    <p id="comprovantePlaceholder" class="comprovante-placeholder">üìÑ Nenhum comprovante enviado</p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="openProofNewTab" style="display: none;">üîç Ampliar</button>
            </div>
        </div>
    </div>
    <!-- Lightbox para ampliar comprovante -->
    <div id="lightboxOverlay" class="lightbox-overlay" style="display: none;" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <div class="lightbox-content" onclick="event.stopPropagation();"></div>
    </div>

    <script>
        const apiBase = '';
        let cachedUsers = [];
        let cachedServices = [];
        let cachedOrders = [];
        let cachedAssignments = [];
        let currentFilter = 'today';
        let currentDateFilter = null;
        let currentServiceFilter = 'all';
        let editingUserId = null;
        let editingServiceId = null;
        let editingAssignmentsUserId = null;

        function showSection(event, sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value,
                role: document.getElementById('userRole').value,
                commission: document.getElementById('userCommission').value,
                status: document.getElementById('userStatus').value,
                password: document.getElementById('userPassword').value || undefined
            };

            fetchJson('/api/users', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Usu√°rio cadastrado com sucesso!');
                this.reset();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('serviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('serviceName').value,
                currency: document.getElementById('serviceCurrency').value || 'BRL',
                costType: document.getElementById('costType').value,
                costFixo: document.getElementById('costFixo').value,
                costPercentual: document.getElementById('costPercentual').value,
                status: document.getElementById('serviceStatus').value,
                description: document.getElementById('serviceDescription').value
            };

            fetchJson('/api/services', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Servi√ßo cadastrado com sucesso!');
                this.reset();
                toggleCostFields();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('assignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                userId: Number(document.getElementById('assignUser').value),
                serviceId: Number(document.getElementById('assignService').value)
            };
            if (!payload.userId || !payload.serviceId) {
                alert('Selecione usu√°rio e servi√ßo.');
                return;
            }
            fetchJson('/api/assignments', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Servi√ßo atribu√≠do com sucesso!');
                this.reset();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('dolarForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('‚úÖ Configura√ß√£o salva com sucesso!');
        });

        function testDolarAPI() {
            const apiUrl = document.getElementById('dolarAPI').value;
            if (!apiUrl) {
                alert('‚ö†Ô∏è Por favor, insira uma URL da API');
                return;
            }
            alert('üîç Testando API...\n\nResultado: Conex√£o bem-sucedida!\nCota√ß√£o: R$ 5,42');
        }

        function openEditUserModal(id) {
            const modal = document.getElementById('editUserModal');
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(id));
            if (!modal || !user) {
                alert('‚ö†Ô∏è Usu√°rio n√£o encontrado para edi√ß√£o.');
                return;
            }

            editingUserId = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserRole').value = user.role || '';
            document.getElementById('editUserCommission').value = user.commission ?? 0;
            document.getElementById('editUserStatus').value = user.status || 'Ativo';
            document.getElementById('editUserPassword').value = '';

            modal.style.display = 'flex';
        }

        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            editingUserId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditUserOverlay(event) {
            if (event.target.id === 'editUserModal') {
                closeEditUserModal();
            }
        }

        const editUserModalEl = document.getElementById('editUserModal');
        if (editUserModalEl) {
            editUserModalEl.addEventListener('click', handleEditUserOverlay);
        }

        function openEditServiceModal(id) {
            const modal = document.getElementById('editServiceModal');
            const service = (cachedServices || []).find(s => Number(s.id) === Number(id));
            if (!modal || !service) {
                alert('‚ö†Ô∏è Servi√ßo n√£o encontrado para edi√ß√£o.');
                return;
            }

            editingServiceId = service.id;
            document.getElementById('editServiceName').value = service.name || '';
            document.getElementById('editServiceCurrency').value = (service.currency || 'BRL').toUpperCase();
            document.getElementById('editCostType').value = service.costType || '';
            document.getElementById('editCostFixo').value = service.costFixo ?? '';
            document.getElementById('editCostPercentual').value = service.costPercentual ?? '';
            document.getElementById('editServiceStatus').value = service.status || 'Ativo';
            document.getElementById('editServiceDescription').value = service.description || '';
            toggleCostFieldsEdit();

            modal.style.display = 'flex';
        }

        function closeEditServiceModal() {
            const modal = document.getElementById('editServiceModal');
            const form = document.getElementById('editServiceForm');
            editingServiceId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditServiceOverlay(event) {
            if (event.target.id === 'editServiceModal') {
                closeEditServiceModal();
            }
        }

        const editServiceModalEl = document.getElementById('editServiceModal');
            if (editServiceModalEl) {
            editServiceModalEl.addEventListener('click', handleEditServiceOverlay);
        }

        function toggleCostFieldsEdit() {
            const costType = document.getElementById('editCostType').value;
            const fixoGroup = document.getElementById('editCostFixoGroup');
            const percentualGroup = document.getElementById('editCostPercentualGroup');
            const fixoInput = document.getElementById('editCostFixo');
            const percentualInput = document.getElementById('editCostPercentual');

            fixoGroup.style.display = 'none';
            percentualGroup.style.display = 'none';
            fixoInput.removeAttribute('required');
            percentualInput.removeAttribute('required');

            if (costType === 'fixo') {
                fixoGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
            } else if (costType === 'percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'fixo_percentual') {
                fixoGroup.style.display = 'flex';
                percentualGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'cotacao_percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            }
        }

        document.getElementById('editServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingServiceId) {
                alert('Nenhum servi√ßo selecionado para edi√ß√£o.');
                return;
            }

            const payload = {
                name: document.getElementById('editServiceName').value,
                currency: document.getElementById('editServiceCurrency').value,
                costType: document.getElementById('editCostType').value,
                costFixo: document.getElementById('editCostFixo').value,
                costPercentual: document.getElementById('editCostPercentual').value,
                status: document.getElementById('editServiceStatus').value,
                description: document.getElementById('editServiceDescription').value
            };

            try {
                await fetchJson(`/api/services/${editingServiceId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('‚úÖ Servi√ßo atualizado com sucesso!');
                closeEditServiceModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        function openEditAssignmentsModal(userId) {
            const modal = document.getElementById('editAssignmentsModal');
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(userId));
            if (!modal || !user) {
                alert('‚ö†Ô∏è Usu√°rio n√£o encontrado para atribui√ß√£o.');
                return;
            }

            editingAssignmentsUserId = user.id;
            const infoEl = document.getElementById('editAssignmentsUserInfo');
            if (infoEl) infoEl.textContent = `Selecione os servi√ßos para ${user.name} (${user.role || 'Sem cargo'})`;

            const currentServices = new Set(
                (cachedAssignments || [])
                    .filter(a => Number(a.userId ?? a.userid) === Number(userId))
                    .map(a => Number(a.serviceId ?? a.serviceid))
            );

            const listEl = document.getElementById('assignServiceList');
            listEl.innerHTML = '';

            if (!cachedServices.length) {
                listEl.innerHTML = '<p style="color:#aaa;">Nenhum servi√ßo cadastrado.</p>';
            } else {
                cachedServices.forEach(service => {
                    const id = service.id;
                    const checkboxId = `assign-service-${id}`;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'checkbox-item';
                    wrapper.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${id}" ${currentServices.has(id) ? 'checked' : ''}>
                        <label for="${checkboxId}">${service.name} ${service.status === 'Inativo' ? '(Inativo)' : ''}</label>
                    `;
                    listEl.appendChild(wrapper);
                });
            }

            modal.style.display = 'flex';
        }

        function closeEditAssignmentsModal() {
            const modal = document.getElementById('editAssignmentsModal');
            const form = document.getElementById('editAssignmentsForm');
            editingAssignmentsUserId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditAssignmentsOverlay(event) {
            if (event.target.id === 'editAssignmentsModal') {
                closeEditAssignmentsModal();
            }
        }

        const editAssignmentsModalEl = document.getElementById('editAssignmentsModal');
        if (editAssignmentsModalEl) {
            editAssignmentsModalEl.addEventListener('click', handleEditAssignmentsOverlay);
        }

        document.getElementById('editAssignmentsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingAssignmentsUserId) {
                alert('Nenhum usu√°rio selecionado para atribuir.');
                return;
            }

            const selectedServiceIds = Array.from(document.querySelectorAll('#assignServiceList input[type="checkbox"]:checked'))
                .map(input => Number(input.value));

            const currentAssignments = (cachedAssignments || []).filter(a => Number(a.userId ?? a.userid) === Number(editingAssignmentsUserId));
            const currentServiceIds = new Set(currentAssignments.map(a => Number(a.serviceId ?? a.serviceid)));
            const assignmentIdByService = currentAssignments.reduce((acc, a) => {
                const sid = Number(a.serviceId ?? a.serviceid);
                acc[sid] = a.id;
                return acc;
            }, {});

            const toAdd = selectedServiceIds.filter(id => !currentServiceIds.has(id));
            const toRemove = Array.from(currentServiceIds).filter(id => !selectedServiceIds.includes(id));

            try {
                await Promise.all(toAdd.map(serviceId => fetchJson('/api/assignments', {
                    method: 'POST',
                    body: JSON.stringify({ userId: editingAssignmentsUserId, serviceId })
                })));

                for (const serviceId of toRemove) {
                    const assignId = assignmentIdByService[serviceId];
                    if (assignId) {
                        await fetchJson(`/api/assignments/${assignId}`, { method: 'DELETE' });
                    }
                }

                alert('‚úÖ Atribui√ß√µes atualizadas com sucesso!');
                closeEditAssignmentsModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingUserId) {
                alert('Nenhum usu√°rio selecionado para edi√ß√£o.');
                return;
            }

            const commissionValue = parseFloat(document.getElementById('editUserCommission').value);
            const password = document.getElementById('editUserPassword').value;

            const payload = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                phone: document.getElementById('editUserPhone').value,
                role: document.getElementById('editUserRole').value,
                commission: Number.isFinite(commissionValue) ? commissionValue : 0,
                status: document.getElementById('editUserStatus').value
            };

            try {
                await fetchJson(`/api/users/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });

                await fetchJson(`/api/users/${editingUserId}/credentials`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        email: payload.email,
                        role: payload.role,
                        password: password || undefined
                    })
                });

                alert('‚úÖ Usu√°rio atualizado com sucesso!');
                closeEditUserModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        function concluirOrdem(id) {
            if (!confirm('Deseja marcar esta ordem como conclu√≠da?')) return;
            fetchJson(`/api/orders/${id}/status`, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'concluded' })
            }).then(() => {
                alert(`‚úÖ Ordem #${id} conclu√≠da com sucesso!`);
                loadAdminData();
            }).catch(showError);
        }

        function verComprovante(id) {
            const modal = document.getElementById('comprovanteModal');
            const order = (cachedOrders || []).find(o => Number(o.id) === Number(id));
            const walletEl = document.getElementById('walletInfo');
            const imgEl = document.getElementById('comprovanteImg');
            const placeholderEl = document.getElementById('comprovantePlaceholder');
            const openNewTabBtn = document.getElementById('openProofNewTab');
            const containerEl = imgEl?.parentElement;

            walletEl.textContent = order?.wallet || '-';

            if (order?.payoutProof) {
                let proofData = order.payoutProof;

                // Se for JSON, parseia e pega o primeiro item
                if (typeof proofData === 'string' && proofData.trim().startsWith('[')) {
                    try {
                        const parsed = JSON.parse(proofData);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            proofData = parsed[0].data || parsed[0];
                        }
                    } catch (e) {
                        console.error('Erro ao parsear JSON do comprovante:', e);
                    }
                }

                const isPDF = typeof proofData === 'string' && proofData.includes('application/pdf');

                if (containerEl) containerEl.innerHTML = '';

                if (isPDF) {
                    const embed = document.createElement('embed');
                    embed.src = proofData;
                    embed.type = 'application/pdf';
                    embed.style.width = '100%';
                    embed.style.height = '60vh';
                    embed.style.borderRadius = '8px';
                    containerEl?.appendChild(embed);
                } else {
                    const img = document.createElement('img');
                    img.src = proofData;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '60vh';
                    img.style.objectFit = 'contain';
                    img.style.borderRadius = '8px';
                    containerEl?.appendChild(img);
                }

                if (placeholderEl) placeholderEl.style.display = 'none';

                if (openNewTabBtn) {
                    openNewTabBtn.textContent = 'üîç Ampliar';
                    openNewTabBtn.style.display = 'inline-flex';
                    openNewTabBtn.onclick = () => {
                        const currentElement = containerEl?.querySelector('img, embed');
                        if (currentElement) {
                            openLightbox(currentElement);
                        } else {
                            alert('‚ö†Ô∏è Nenhum conte√∫do dispon√≠vel para ampliar.');
                        }
                    };
                }
            } else {
                if (containerEl) {
                    containerEl.innerHTML = '<p id="comprovantePlaceholder" class="comprovante-placeholder">üìÑ Nenhum comprovante enviado</p>';
                }
                if (openNewTabBtn) openNewTabBtn.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('comprovanteModal').style.display = 'none';
        }

        function openLightbox(contentElement) {
            const lightbox = document.getElementById('lightboxOverlay');
            const lightboxContent = lightbox.querySelector('.lightbox-content');

            lightboxContent.innerHTML = '';

            const clone = contentElement.cloneNode(true);
            clone.style.display = 'block';
            clone.removeAttribute('id');
            lightboxContent.appendChild(clone);

            lightbox.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightboxOverlay');
            lightbox.style.display = 'none';
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const lightbox = document.getElementById('lightboxOverlay');
                if (lightbox && lightbox.style.display === 'flex') {
                    closeLightbox();
                }
            }
        });

        async function atualizarCotacao() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL');
                const data = await response.json();

                if (data && data.price) {
                    const price = parseFloat(data.price).toFixed(4);
                    const priceFormatted = 'R$ ' + price.replace('.', ',');
                    document.getElementById('usdtPrice').textContent = priceFormatted;
                    const topPriceEl = document.getElementById('topUsdtPrice');
                    if (topPriceEl) {
                        topPriceEl.textContent = priceFormatted;
                    }
                    const usdtPriceGerenteEl = document.getElementById('usdtPriceGerente');
                    if (usdtPriceGerenteEl) usdtPriceGerenteEl.textContent = priceFormatted;

                    const now = new Date();
                    const dateStr = now.toLocaleDateString('pt-BR');
                    const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('lastUpdate').textContent = dateStr;
                    document.getElementById('lastUpdateTime').textContent = timeStr;

                    console.log('Cota√ß√£o USDT atualizada:', price);
                } else {
                    alert('‚ö†Ô∏è Erro ao buscar cota√ß√£o da Binance');
                }
            } catch (error) {
                console.error('Erro ao buscar cota√ß√£o:', error);
                alert('‚ö†Ô∏è Erro ao conectar com a API da Binance');
            }
        }

        function attachPhoneMask(elementId) {
            const input = document.getElementById(elementId);
            if (!input) return;
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);

                if (value.length > 6) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
                } else if (value.length > 2) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
                }

                e.target.value = value;
            });
        }

        attachPhoneMask('userPhone');
        attachPhoneMask('editUserPhone');

        function toggleCostFields() {
            const costType = document.getElementById('costType').value;
            const fixoGroup = document.getElementById('costFixoGroup');
            const percentualGroup = document.getElementById('costPercentualGroup');
            const fixoInput = document.getElementById('costFixo');
            const percentualInput = document.getElementById('costPercentual');

            fixoGroup.style.display = 'none';
            percentualGroup.style.display = 'none';
            fixoInput.removeAttribute('required');
            percentualInput.removeAttribute('required');

            if (costType === 'fixo') {
                fixoGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
            } else if (costType === 'percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'fixo_percentual') {
                fixoGroup.style.display = 'flex';
                percentualGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'cotacao_percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            }
        }

        function darBaixaComissao(id, vendedor, valor) {
            if (confirm(`Confirmar pagamento da comiss√£o de R$ ${valor.toFixed(2).replace('.', ',')} para ${vendedor}?`)) {
                fetchJson(`/api/orders/${id}/commission`, {
                    method: 'PATCH',
                    body: JSON.stringify({ commissionPaid: true })
                }).then(() => {
                    alert(`‚úÖ Comiss√£o #${id} paga com sucesso!`);
                    loadAdminData();
                }).catch(showError);
            }
        }

        function showError(err) {
            console.error(err);
            alert('‚ö†Ô∏è Erro: ' + (err?.message || 'n√£o foi poss√≠vel completar a a√ß√£o'));
        }

        async function fetchJson(path, options = {}) {
            const res = await fetch(apiBase + path, {
                credentials: 'include',
                cache: 'no-store',
                ...options,
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) }
            });
            if (res.status === 401) {
                window.location.href = '/login-admin.html';
                return;
            }
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || res.statusText);
            }
            return res.status === 204 ? null : res.json();
        }

        function formatBRL(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatBRL4(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4, maximumFractionDigits: 4 });
        }

        function formatCurrencyValue(currency, value) {
            const num = Number(value ?? 0);
            if (!Number.isFinite(num)) return value ?? '-';
            if ((currency || '').toUpperCase() === 'USD') {
                return '$ ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return formatBRL(num);
        }

        function formatDate(value) {
            if (!value) return '--';
            if (typeof value === 'string') {
                const match = value.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (match) {
                    const [, y, m, d] = match;
                    return `${d}/${m}/${y}`;
                }
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return new Intl.DateTimeFormat('pt-BR', { timeZone: 'UTC' }).format(date);
        }

        function formatLaunchDate(order = {}) {
            return formatDate(order.launchDate || order.launchdate || order.created_at || order.createdAt || null);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role || '--'}</td>
                    <td><span class=\"badge badge-gold\">${(user.commission ?? 0)}%</span></td>
                    <td><span class=\"badge ${user.status === 'Ativo' ? 'badge-success' : 'badge-warning'}\">${user.status}</span></td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar\" onclick=\"openEditUserModal(${user.id})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Excluir\" onclick=\"deleteUser(${user.id})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderServices(services) {
            const tbody = document.getElementById('servicesTableBody') || document.querySelector('#servicesTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            services.forEach(service => {
                const currency = (service.currency || 'BRL').toUpperCase();
                const fixedValue = formatCurrencyValue(currency, service.costFixo);
                const costLabel = service.costType === 'fixo' ? fixedValue :
                    service.costType === 'percentual' ? `${service.costPercentual}%` :
                    service.costType === 'fixo_percentual' ? `${fixedValue} + ${service.costPercentual}%` :
                    `Cota√ß√£o (${currency}) + ${service.costPercentual}%`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${service.name}</td>
                    <td>${costLabel}</td>
                    <td><span class=\"badge ${service.status === 'Ativo' ? 'badge-success' : 'badge-warning'}\">${service.status}</span></td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar\" onclick=\"openEditServiceModal(${service.id})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Excluir\" onclick=\"deleteService(${service.id})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateAssignSelects(users, services) {
            const userSelect = document.getElementById('assignUser');
            const serviceSelect = document.getElementById('assignService');
            if (!userSelect || !serviceSelect) return;
            userSelect.innerHTML = '<option value=\"\">Selecione...</option>';
            serviceSelect.innerHTML = '<option value=\"\">Selecione...</option>';

            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = `${u.name} (${u.role || 'Sem cargo'})`;
                userSelect.appendChild(opt);
            });

            services.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                serviceSelect.appendChild(opt);
            });
        }

        function renderAssignments(assignments) {
            const tbody = document.getElementById('assignmentsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!assignments.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan=\"4\" style=\"text-align:center; color:#aaa;\">Nenhum servi√ßo atribu√≠do.</td>`;
                tbody.appendChild(tr);
                return;
            }

            // Agrupa servi√ßos por usu√°rio
            const grouped = assignments.reduce((acc, item) => {
                const userId = item.userId ?? item.userid;
                if (!userId) return acc;
                if (!acc[userId]) {
                    acc[userId] = {
                        userId,
                        username: item.username || '‚Äî',
                        role: item.role || '-',
                        services: [],
                        serviceIds: [],
                        assignmentIds: {}
                    };
                }
                const serviceName = item.serviceName || item.servicename || '-';
                const serviceId = item.serviceId ?? item.serviceid;
                acc[userId].services.push(serviceName);
                if (serviceId) acc[userId].serviceIds.push(serviceId);
                if (serviceId && item.id) acc[userId].assignmentIds[serviceId] = item.id;
                return acc;
            }, {});

            Object.values(grouped).forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${user.services.join(', ')}</td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar servi√ßos\" onclick=\"openEditAssignmentsModal(${user.userId})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Remover todos\" onclick=\"removeAllAssignmentsForUser(${user.userId})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterOrdersByPeriod(orders, period, selectedDate) {
            if (!orders || !orders.length) return [];
            const normalized = (period || 'all').toLowerCase();
            if (normalized === 'all') return [...orders];
            const getDateOnly = (value) => {
                if (!value) return null;
                if (typeof value === 'string') return value.slice(0, 10);
                const d = new Date(value);
                if (!Number.isFinite(d.getTime())) return null;
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            if (normalized === 'date' && selectedDate) {
                const targetStr = getDateOnly(selectedDate);
                if (!targetStr) return [...orders];
                return orders.filter(o => getDateOnly(o.date) === targetStr);
            }

            if (normalized === 'today') {
                return orders.filter(o => getDateOnly(o.date) === todayStr);
            }

            if (normalized === 'month') {
                const yearMonth = todayStr.slice(0, 7);
                return orders.filter(o => {
                    const d = getDateOnly(o.date);
                    return d && d.startsWith(yearMonth);
                });
            }

            if (normalized === 'week') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const dayOfWeek = today.getDay();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - dayOfWeek); // domingo
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6); // s√°bado

                const startStr = `${startOfWeek.getFullYear()}-${String(startOfWeek.getMonth() + 1).padStart(2, '0')}-${String(startOfWeek.getDate()).padStart(2, '0')}`;
                const endStr = `${endOfWeek.getFullYear()}-${String(endOfWeek.getMonth() + 1).padStart(2, '0')}-${String(endOfWeek.getDate()).padStart(2, '0')}`;

                return orders.filter(o => {
                    const d = getDateOnly(o.date);
                    return d && d >= startStr && d <= endStr;
                });
            }

            return [...orders];
        }

        function renderOrders(orders, users, services) {
            const usersMap = Object.fromEntries(users.map(u => [u.id, u]));
            const servicesMap = Object.fromEntries(services.map(s => [s.id, s]));

            const openTbody = document.getElementById('openOrdersTbody');
            const concludedTbody = document.getElementById('concludedOrdersTbody');
            if (openTbody) openTbody.innerHTML = '';
            if (concludedTbody) concludedTbody.innerHTML = '';

            const pendingCommissionsTbody = document.getElementById('pendingCommissionsTbody');
            const paidCommissionsTbody = document.getElementById('paidCommissionsTbody');
            if (pendingCommissionsTbody) pendingCommissionsTbody.innerHTML = '';
            if (paidCommissionsTbody) paidCommissionsTbody.innerHTML = '';

            orders.forEach(order => {
                const seller = usersMap[order.sellerId];
                const service = servicesMap[order.serviceId];
                const serviceName = service?.name || order.productType || 'Servi√ßo';
                const sellerName = seller?.name || '‚Äî';
                const commissionValue = order.commissionValue ?? 0;
                const status = order.status || 'open';
                const unitPriceDisplay = Number(order.unitPrice) || (order.price && order.quantity ? Number(order.price) / Number(order.quantity) : null);
                const isRetro = order.isRetroactive || order.isretroactive || false;

                const hasProof = Boolean(order.payoutProof);
                const proofStatus = `<span class="proof-status" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${hasProof ? '#10b981' : '#ef4444'};"></span>`;
                const hedgeCompleted = Boolean(order.hedgeCompleted);
                const hedgeTotalBrl = Number(order.hedgeTotalBrl ?? 0) || 0;
                const hedgeDate = order.hedgeAt ? new Date(order.hedgeAt) : null;
                const hedgeDateLabel = hedgeDate && !Number.isNaN(hedgeDate.getTime()) ? hedgeDate.toLocaleDateString('pt-BR') : '';
                const hedgeCell = hedgeCompleted && hedgeTotalBrl > 0
                    ? `
                        <div style="color: #10b981; font-weight: 700;">
                            ‚úÖ ${formatBRL(hedgeTotalBrl)}
                        </div>
                        ${hedgeDateLabel ? `<small style="color: #9ca3af;">${hedgeDateLabel}</small>` : ''}
                      `
                    : `<button class="btn-trava" data-order-id="${order.id}">Registrar Trava</button>`;
                const canConclude = hasProof && hedgeCompleted && hedgeTotalBrl > 0;
                const concludeBtn = `<button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem; ${canConclude ? '' : 'opacity:0.4;'}" ${canConclude ? `onclick=\"concluirOrdem(${order.id})\"` : 'disabled title="Requer comprovante e trava registrada"'}>‚úÖ Concluir</button>`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${order.id}${isRetro ? ' <span class="badge" style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); font-size: 0.65rem;">üìÖ RETRO</span>' : ''}</td>
                    <td>${order.customer || '-'}</td>
                    <td>${sellerName}</td>
                    <td><span class=\"badge badge-gold\">${serviceName}</span></td>
                    <td>${order.quantity != null ? order.quantity : '-'}</td>
                    <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                    <td>${order.wallet ? `<span title=\"${order.wallet}\">${order.wallet}</span>` : '-'}</td>
                    <td>${formatBRL(order.price)}</td>
                    <td>${formatBRL(order.cost)}</td>
                    <td class=\"profit-color\">${formatBRL(order.profit)}</td>
                    <td class=\"profit-color\">${formatBRL(commissionValue)}</td>
                    <td title="${order.historicalQuote ? 'Cota√ß√£o hist√≥rica: R$ ' + Number(order.historicalQuote).toFixed(4) : 'Cota√ß√£o autom√°tica'}">${formatDate(order.date)}</td>
                    <td>${formatLaunchDate(order)}</td>
                    <td style="text-align:center;">${proofStatus}</td>
                    <td class=\"proof-col\">${order.payoutProof ? `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"verComprovante(${order.id})\">üìé Ver</button>` : '-'}</td>
                    <td>${hedgeCell}</td>
                    <td class=\"actions-col\">${status === 'open' ? concludeBtn : '<span class=\"badge badge-success\">Conclu√≠da</span>'}</td>
                `;

                if (status === 'open' && openTbody) openTbody.appendChild(tr);
                // tabela de conclu√≠das renderizada separadamente

                if (status === 'concluded') {
                    const totalSale = Number(order.price) || 0;
                    const profitValue = Number(order.profit) || 0;
                    const commissionRate = seller?.commission ?? 0;
                    const periodLabel = new Date(order.date || Date.now()).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    const dateLabel = formatDate(order.date);
                    const paymentDateLabel = formatDate(order.date);

                    const commTr = document.createElement('tr');
                    commTr.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${sellerName}</td>
                        <td>${seller?.role || '-'}</td>
                        <td>${formatBRL(totalSale)}</td>
                        <td class=\"profit-color\">${formatBRL(profitValue)}</td>
                        <td>${commissionRate}%</td>
                        <td class=\"profit-color\" style=\"font-weight: 700; font-size: 1.1rem;\">${formatBRL(commissionValue)}</td>
                        <td>${dateLabel}</td>
                        <td>${formatLaunchDate(order)}</td>
                        <td>${periodLabel}</td>
                        <td>
                            ${order.commissionPaid ? '<span class=\"badge badge-success\">Pago</span>' : `<button class=\"btn btn-success\" onclick=\"darBaixaComissao(${order.id}, '${sellerName}', ${commissionValue})\" style=\"padding: 0.5rem 1rem;\">‚úÖ Dar Baixa</button>`}
                        </td>
                    `;

                    const commPaidTr = document.createElement('tr');
                    commPaidTr.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${sellerName}</td>
                        <td>${seller?.role || '-'}</td>
                        <td>${formatBRL(totalSale)}</td>
                        <td class=\"profit-color\">${formatBRL(profitValue)}</td>
                        <td>${commissionRate}%</td>
                        <td class=\"profit-color\" style=\"font-weight: 700; font-size: 1.1rem;\">${formatBRL(commissionValue)}</td>
                        <td>${periodLabel}</td>
                        <td>${paymentDateLabel}</td>
                        <td><span class=\"badge badge-success\">Pago</span></td>
                    `;

                    if (!order.commissionPaid && pendingCommissionsTbody) pendingCommissionsTbody.appendChild(commTr);
                    if (order.commissionPaid && paidCommissionsTbody) paidCommissionsTbody.appendChild(commPaidTr);
                }
            });
        }

        async function deleteUser(id) {
            if (!confirm('Deseja excluir este usu√°rio?')) return;
            await fetchJson(`/api/users/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function deleteService(id) {
            if (!confirm('Deseja excluir este servi√ßo?')) return;
            await fetchJson(`/api/services/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function deleteAssignment(id) {
            if (!confirm('Remover este servi√ßo atribu√≠do?')) return;
            await fetchJson(`/api/assignments/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function removeAllAssignmentsForUser(userId) {
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(userId));
            if (!user) return;
            if (!confirm(`Remover todas as atribui√ß√µes de ${user.name}?`)) return;
            const assignments = (cachedAssignments || []).filter(a => Number(a.userId ?? a.userid) === Number(userId));
            for (const assign of assignments) {
                await fetchJson(`/api/assignments/${assign.id}`, { method: 'DELETE' });
            }
            loadAdminData();
        }

        // Modal de Trava (hedge)
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-trava')) {
                e.preventDefault();
                const orderId = e.target.dataset.orderId;
                await openHedgeModal(orderId);
            }
        });

        async function openHedgeModal(orderId) {
            const order = (cachedOrders || []).find(o => Number(o.id) === Number(orderId));
            if (!order) {
                alert('Ordem n√£o encontrada para registrar trava.');
                return;
            }

            const existing = document.querySelector('.hedge-modal-overlay');
            if (existing) existing.remove();

            const now = new Date();
            const isoLocal = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

            const overlay = document.createElement('div');
            overlay.className = 'hedge-modal-overlay';
            overlay.innerHTML = `
                <div class="hedge-modal" onclick="event.stopPropagation();">
                    <h3>Registrar Trava - Ordem #${orderId}</h3>
                    <p><strong>Cliente:</strong> ${order.customer || '-'}</p>
                    <p><strong>Remessa:</strong> ${order.quantity || 0} USD</p>
                    <p><strong>Custo estimado:</strong> ${formatBRL(order.cost || 0)}</p>
                    
                    <form id="hedge-form">
                        <div class="form-group">
                            <label>Total BRL (obrigat√≥rio) *</label>
                            <input type="number" step="0.01" name="hedgeTotalBrl" required placeholder="Ex: 5480.00">
                            <small>Custo total pago na execu√ß√£o da trava</small>
                        </div>

                        <div class="form-group">
                            <label>Quantidade USDT (opcional)</label>
                            <input type="number" step="0.00000001" name="hedgeQtyUsdt" placeholder="Ex: 1000.00">
                        </div>

                        <div class="form-group">
                            <label>Pre√ßo BRL/USDT (opcional)</label>
                            <input type="number" step="0.00000001" name="hedgePriceBrl" placeholder="Ex: 5.48">
                        </div>

                        <div class="form-group">
                            <label>Data/Hora</label>
                            <input type="datetime-local" name="hedgeAt" value="${isoLocal}">
                        </div>

                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea name="hedgeNotes" rows="3" placeholder="Ex: Executado via Binance P2P"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">Salvar Trava</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.hedge-modal-overlay').remove()">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;

            overlay.addEventListener('click', (ev) => {
                if (ev.target === overlay) overlay.remove();
            });

            document.body.appendChild(overlay);

            const form = overlay.querySelector('#hedge-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const payload = {
                    hedgeTotalBrl: formData.get('hedgeTotalBrl') ? parseFloat(formData.get('hedgeTotalBrl')) : null,
                    hedgeQtyUsdt: formData.get('hedgeQtyUsdt') ? parseFloat(formData.get('hedgeQtyUsdt')) : null,
                    hedgePriceBrl: formData.get('hedgePriceBrl') ? parseFloat(formData.get('hedgePriceBrl')) : null,
                    hedgeAt: formData.get('hedgeAt') || null,
                    hedgeNotes: formData.get('hedgeNotes') || null
                };

                try {
                    await fetchJson(`/api/orders/${orderId}/hedge`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    alert('‚úÖ Trava registrada com sucesso!');
                    overlay.remove();
                    await loadAdminData();
                } catch (err) {
                    alert(err?.message || 'Erro ao salvar trava');
                }
            });
        }

        async function loadAdminData() {
            try {
                const results = await Promise.allSettled([
                    fetchJson('/api/users'),
                    fetchJson('/api/services'),
                    fetchJson('/api/orders'),
                    fetchJson('/api/assignments')
                ]);

                const users = results[0].status === 'fulfilled' ? results[0].value : [];
                const services = results[1].status === 'fulfilled' ? results[1].value : [];
                const orders = results[2].status === 'fulfilled' ? results[2].value : [];
                const assignments = results[3].status === 'fulfilled' ? results[3].value : [];

                cachedUsers = users;
                cachedServices = services;
                cachedOrders = orders;
                cachedAssignments = assignments;
                renderUsers(users);
                renderServices(services);
                updateAssignSelects(users, services);
                renderAssignments(assignments);
                applyFilterAndRender();
                populateServiceFilter();
                await loadRemessaDashboard();

                const failed = results.filter(r => r.status === 'rejected');
                if (failed.length) {
                    console.warn('Algumas fontes falharam ao carregar:', failed.map(f => f.reason?.message || f.reason));
                }
            } catch (err) {
                showError(err);
            }
        }

        window.addEventListener('load', function() {
            atualizarCotacao();
            setFilter('today');
            loadAdminData();
        });

        function setFilter(period, dateValue) {
            const normalized = (period || 'all').toLowerCase();
            currentFilter = normalized;
            currentDateFilter = normalized === 'date' ? dateValue : null;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                const btnPeriod = (btn.dataset.period || '').toLowerCase();
                btn.classList.toggle('active', btnPeriod === normalized);
            });

            if (normalized === 'date') {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            } else {
                const dateInput = document.getElementById('filterDateInput');
                if (dateInput) dateInput.value = '';
            }

            applyFilterAndRender();
        }

        function applyFilterAndRender() {
            const filteredOrders = filterOrdersByPeriod(cachedOrders, currentFilter, currentDateFilter);
            updateKpis(filteredOrders, cachedOrders, currentFilter);
            renderOrders(filteredOrders, cachedUsers, cachedServices);
            renderFilteredConcludedOrders();
            loadRemessaDashboard();
        }

        function populateServiceFilter() {
            const select = document.getElementById('serviceFilterConcluded');
            if (!select) return;
            
            const currentValue = select.value || 'all';
            select.innerHTML = '<option value="all">Todos os Servi√ßos</option>';
            
            cachedServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.name;
                option.textContent = service.name + (service.status === 'Inativo' ? ' (Inativo)' : '');
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        function filterConcludedOrdersByService() {
            const select = document.getElementById('serviceFilterConcluded');
            currentServiceFilter = select ? select.value : 'all';
            renderFilteredConcludedOrders();
        }

        function renderFilteredConcludedOrders() {
            const filteredOrders = filterOrdersByPeriod(cachedOrders, currentFilter, currentDateFilter);
            const concludedOrders = filteredOrders.filter(o => (o.status || 'open') === 'concluded');
            
            const finalOrders = currentServiceFilter === 'all' 
                ? concludedOrders 
                : concludedOrders.filter(order => {
                    const service = cachedServices.find(s => s.id === order.serviceId);
                    const serviceName = service?.name || order.productType || '';
                    return serviceName.toLowerCase().includes(currentServiceFilter.toLowerCase());
                });
            
            renderConcludedOrdersTable(finalOrders);
        }

        function renderConcludedOrdersTable(orders) {
            const concludedTbody = document.getElementById('concludedOrdersTbody');
            if (!concludedTbody) return;
            concludedTbody.innerHTML = '';
            
            const usersMap = Object.fromEntries(cachedUsers.map(u => [u.id, u]));
            const servicesMap = Object.fromEntries(cachedServices.map(s => [s.id, s]));
            
            orders.forEach(order => {
                const seller = usersMap[order.sellerId];
                const service = servicesMap[order.serviceId];
                const serviceName = service?.name || order.productType || 'Servi√ßo';
                const sellerName = seller?.name || '‚Äî';
                const commissionValue = order.commissionValue ?? 0;
                const unitPriceDisplay = Number(order.unitPrice) || (order.price && order.quantity ? Number(order.price) / Number(order.quantity) : null);
                const isRetro = order.isRetroactive || order.isretroactive || false;
                
                const hasProof = Boolean(order.payoutProof);
                const proofStatus = `<span class="proof-status" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${hasProof ? '#10b981' : '#ef4444'};"></span>`;
                
                const hedgeCompleted = Boolean(order.hedgeCompleted);
                const hedgeTotalBrl = Number(order.hedgeTotalBrl ?? 0) || 0;
                const hedgeDate = order.hedgeAt ? new Date(order.hedgeAt) : null;
                const hedgeDateLabel = hedgeDate && !Number.isNaN(hedgeDate.getTime()) ? hedgeDate.toLocaleDateString('pt-BR') : '';
                const hedgeCell = hedgeCompleted && hedgeTotalBrl > 0
                    ? `<div style="color: #10b981; font-weight: 700;">‚úÖ ${formatBRL(hedgeTotalBrl)}</div>${hedgeDateLabel ? `<small style="color: #9ca3af;">${hedgeDateLabel}</small>` : ''}`
                    : `<button class="btn-trava" data-order-id="${order.id}">Registrar Trava</button>`;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${order.id}${isRetro ? ' <span class="badge" style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); font-size: 0.65rem;">üìÖ RETRO</span>' : ''}</td>
                    <td>${order.customer || '-'}</td>
                    <td>${sellerName}</td>
                    <td><span class="badge badge-gold">${serviceName}</span></td>
                    <td>${order.quantity != null ? order.quantity : '-'}</td>
                    <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                    <td>${order.wallet ? `<span title="${order.wallet}">${order.wallet}</span>` : '-'}</td>
                    <td>${formatBRL(order.price)}</td>
                    <td>${formatBRL(order.cost)}</td>
                    <td class="profit-color">${formatBRL(order.profit)}</td>
                    <td class="profit-color">${formatBRL(commissionValue)}</td>
                    <td title="${order.historicalQuote ? 'Cota√ß√£o hist√≥rica: R$ ' + Number(order.historicalQuote).toFixed(4) : 'Cota√ß√£o autom√°tica'}">${formatDate(order.date)}</td>
                    <td>${formatLaunchDate(order)}</td>
                    <td style="text-align:center;">${proofStatus}</td>
                    <td class="proof-col">${order.payoutProof ? `<button class="btn btn-secondary" style="padding: 0.35rem 0.75rem; font-size: 0.85rem;" onclick="verComprovante(${order.id})">üìé Ver</button>` : '-'}</td>
                    <td>${hedgeCell}</td>
                    <td class="actions-col"><span class="badge badge-success">Conclu√≠da</span></td>
                `;
                concludedTbody.appendChild(tr);
            });
            
            if (!orders.length) {
                const emptyTr = document.createElement('tr');
                emptyTr.innerHTML = '<td colspan="16" style="text-align: center; color: #888; padding: 2rem;">Nenhuma ordem conclu√≠da encontrada para este filtro</td>';
                concludedTbody.appendChild(emptyTr);
            }
        }

        function updateKpis(filteredOrders = [], allOrders = [], currentPeriod = 'all') {
            const hasAll = Array.isArray(allOrders) && allOrders.length;
            const sourceOrders = currentPeriod === 'all' && hasAll ? allOrders : filteredOrders;
            const closedOrders = sourceOrders.filter(o => (o.status || 'open') === 'concluded');

            // KPIs financeiros consideram todas as ordens
            const totalCost = closedOrders.reduce((acc, o) => acc + (Number(o.cost) || 0), 0);
            const totalNetProfit = closedOrders.reduce((acc, o) => {
                const profit = Number(o.profit) || 0;
                const commission = Number(o.commissionValue ?? o.commissionvalue ?? 0) || 0;
                return acc + (profit - commission);
            }, 0);

            // Contadores seguem o conjunto filtrado (per√≠odo selecionado)
            const openCount = filteredOrders.filter(o => (o.status || 'open') === 'open').length;
            const closedCount = filteredOrders.filter(o => (o.status || 'open') === 'concluded').length;

            const costEl = document.getElementById('kpiCost');
            const profitEl = document.getElementById('kpiProfit');
            const openEl = document.getElementById('kpiOpen');
            const closedEl = document.getElementById('kpiClosed');

            if (costEl) costEl.textContent = formatBRL(totalCost);
            if (profitEl) profitEl.textContent = formatBRL(totalNetProfit);
            if (openEl) openEl.textContent = openCount.toString();
            if (closedEl) closedEl.textContent = closedCount.toString();
        }

        function updateRemessaKpis(data = {}) {
            const tx = Number(data.somaLucroTx || 0);
            const repasse = Number(data.somaLucroRepasse || 0);
            const total = Number(data.somaLucroTotal || 0);
            const repasseIntermediario = Number(data.somaRepasseIntermediario || 0);

            const setValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = formatBRL(value);
            };

            setValue('kpiRemessaLucroTx', tx);
            setValue('kpiRemessaLucroRepasse', repasse);
            setValue('kpiRemessaLucroTotal', total);
            setValue('kpiRepasseIntermediario', repasseIntermediario);

            const warningContainer = document.getElementById('remessaWarnings');
            if (warningContainer) {
                const warnings = [];
                if (data.temOrdensSemCotacao) {
                    warnings.push(`${data.ordensSemBaseQuote || 0} ordem(ns) sem cota√ß√£o base`);
                }
                if (data.temFallbackUnitPrice) {
                    warnings.push(`${data.ordensComFallbackUnitPrice || 0} ordem(ns) usando fallback de pre√ßo`);
                }

                if (warnings.length) {
                    warningContainer.innerHTML = `
                        <div class="info-box" style="background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3); margin-top: 1rem;">
                            <span class="info-box-icon">‚ö†Ô∏è</span>
                            <div class="info-box-text" style="color: #fbbf24;">
                                <strong>Aten√ß√£o:</strong> ${warnings.join(' | ')}
                            </div>
                        </div>
                    `;
                    warningContainer.style.display = 'block';
                } else {
                    warningContainer.style.display = 'none';
                    warningContainer.innerHTML = '';
                }
            }
        }

        async function loadRemessaDashboard() {
            try {
                const periodo = currentFilter || 'all';
                const dateParam = currentFilter === 'date' && currentDateFilter ? `&date=${encodeURIComponent(currentDateFilter)}` : '';
                const data = await fetchJson(`/api/dashboard/remessa?periodo=${encodeURIComponent(periodo)}${dateParam}`);
                updateRemessaKpis(data || {});
            } catch (error) {
                console.error('Erro ao carregar dashboard remessa:', error);
            }
        }
    </script>
</body>
</html>
