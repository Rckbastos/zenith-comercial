<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Comercial - Admin Completo</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zenith">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D4AF37">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="zenith-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="pwa.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding-left: 0;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #D4AF37;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 60px;
            height: 60px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #D4AF37;
        }

        .header-title p {
            font-size: 0.875rem;
            color: #888;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(212, 175, 55, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #D4AF37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #0a0a0a;
        }

        .top-info-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #1a3a52 0%, #0a2a42 100%);
            border-bottom: 2px solid #D4AF37;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .top-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-info-label {
            color: #D4AF37;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .top-info-value {
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
        }

        .top-info-sep {
            height: 20px;
            width: 1px;
            background: #D4AF37;
        }

        /* Container */
        .container {
            max-width: 1760px;
            margin: 0 auto;
            padding: 2.75rem 2.25rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem 1.25rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem;
            background: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
            position: static;
            width: 100%;
            box-shadow: none;
        }

        .nav-tab {
            padding: 0.35rem 0.65rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #c8c8c8;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.08);
        }

        .nav-tab.active {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.12);
            border-bottom: 2px solid #D4AF37;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Dashboard Section */
        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            color: #888;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a1a;
            color: #888;
            border: 1px solid #333;
        }

        .filter-btn:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .filter-btn.active {
            background: #D4AF37;
            color: #0a0a0a;
            border-color: #D4AF37;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            border-color: #D4AF37;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.1);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.875rem;
            color: #888;
            font-weight: 500;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .kpi-icon.cost {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .kpi-icon.profit {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        .kpi-icon.orders {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .kpi-value.profit-color {
            color: #D4AF37;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #888;
        }

        /* Form Styles */
        .form-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-card.narrow {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
         }

        .form-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #D4AF37;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #888;
        }

        .form-group label span {
            color: #D4AF37;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem 1rem;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #b8941f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .btn-success {
            background: #10b981;
            color: #0a0a0a;
        }

        .btn-success:hover {
            background: #0e9c75;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            table-layout: auto;
        }

        .data-table thead {
            background: rgba(212, 175, 55, 0.1);
        }

        .data-table th {
            padding: 1.2rem 1.25rem;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 600;
            color: #D4AF37;
            border-bottom: 2px solid #D4AF37;
        }

        .data-table td {
            padding: 1.2rem 1.25rem;
            border-bottom: 1px solid #333;
            font-size: 1rem;
        }

        .data-table tbody tr {
            transition: all 0.3s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge-gold {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 0.25rem;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .btn-edit:hover {
            background: #3b82f6;
            color: #fff;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: #fff;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            backdrop-filter: blur(2px);
        }

        .modal-card {
            background: #0f0f0f;
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 1.75rem;
            width: min(900px, 94vw);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .modal-header h3 {
            color: #D4AF37;
        }

        .modal-close {
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: #D4AF37;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .modal-subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.65rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 0.75rem;
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #D4AF37;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #e5e7eb;
            font-weight: 600;
        }

        .info-box {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .info-box-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box-text {
            font-size: 0.875rem;
            color: #D4AF37;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            body {
                padding-left: 0;
            }

            .nav-tabs {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
                width: auto;
                box-shadow: none;
            }

            .dashboard-header h2 {
                font-size: 1.5rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }

            .nav-tabs {
                overflow-x: scroll;
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="top-info-bar">
        <div class="top-info-item">
            <span class="top-info-label">üí∞ D√≥lar:</span>
            <span id="topUsdtPrice" class="top-info-value">R$ --</span>
        </div>
    </div>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo">
                <img src="zenith-logo.png" alt="Zenith Logo">
            </div>
            <div class="header-title">
                <h1>Zenith Comercial</h1>
                <p>Sistema de Gest√£o Administrativo</p>
            </div>
        </div>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <span>Admin</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection(event, 'dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection(event, 'usuarios')">üë• Usu√°rios</button>
            <button class="nav-tab" onclick="showSection(event, 'servicos')">üõ†Ô∏è Servi√ßos</button>
            <button class="nav-tab" onclick="showSection(event, 'atribuir')">üîó Atribuir Servi√ßos</button>
            <button class="nav-tab" onclick="showSection(event, 'dolar')">üí± Cota√ß√£o D√≥lar</button>
            <button class="nav-tab" onclick="showSection(event, 'ordens-abertas')">üìã Ordens Abertas</button>
            <button class="nav-tab" onclick="showSection(event, 'ordens-concluidas')">‚úÖ Ordens Conclu√≠das</button>
            <button class="nav-tab" onclick="showSection(event, 'comissoes-pendentes')">üíµ Comiss√µes Pendentes</button>
            <button class="nav-tab" onclick="showSection(event, 'comissoes-pagas')">‚úÖ Comiss√µes Pagas</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="dashboard-header">
                <h2>Dashboard Financeiro</h2>
                <p>Vis√£o geral do desempenho comercial</p>
            </div>

            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setFilter('today')">Hoje</button>
                <button class="filter-btn" onclick="setFilter('week')">Semanal</button>
                <button class="filter-btn" onclick="setFilter('month')">Mensal</button>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Custo Total</span>
                        <div class="kpi-icon cost">üí∞</div>
                    </div>
                    <div class="kpi-value" id="kpiCost">R$ 0,00</div>
                    <div class="kpi-trend">
                        <span>‚Üì</span>
                        <span>Despesas operacionais</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Lucro Total</span>
                        <div class="kpi-icon profit">üìà</div>
                    </div>
                    <div class="kpi-value profit-color" id="kpiProfit">R$ 0,00</div>
                    <div class="kpi-trend">
                        <span>‚Üë</span>
                        <span>Margem de lucro</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Ordens Abertas</span>
                        <div class="kpi-icon orders">üì¶</div>
                    </div>
                    <div class="kpi-value" id="kpiOpen">0</div>
                    <div class="kpi-trend">
                        <span>‚è≥</span>
                        <span>Aguardando conclus√£o</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Ordens Conclu√≠das</span>
                        <div class="kpi-icon orders">‚úÖ</div>
                    </div>
                    <div class="kpi-value" id="kpiClosed">0</div>
                    <div class="kpi-trend">
                        <span>‚Üë</span>
                        <span>Total processado</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usu√°rios Section -->
        <div id="usuarios" class="content-section">
            <div class="form-card">
                <h3><span>üë§</span> Cadastrar Usu√°rio e Comiss√£o</h3>
                <form id="userForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Completo <span>*</span></label>
                            <input type="text" id="userName" placeholder="Ex: Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label>E-mail <span>*</span></label>
                            <input type="email" id="userEmail" placeholder="joao@zenith.com" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone <span>*</span></label>
                            <input type="tel" id="userPhone" placeholder="(11) 99999-9999" required autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label>Cargo <span>*</span></label>
                            <select id="userRole" required>
                                <option value="">Selecione...</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Gerente de Contas">Gerente de Contas</option>
                                <option value="Consultor Comercial">Consultor Comercial</option>
                                <option value="Executivo de Vendas">Executivo de Vendas</option>
                                <option value="Analista Comercial">Analista Comercial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Senha de acesso</label>
                            <input type="password" id="userPassword" placeholder="Defina a senha para login" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>Comiss√£o sobre Lucro (%) <span>*</span></label>
                            <input type="number" id="userCommission" placeholder="Ex: 15" min="0" max="100" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Status <span>*</span></label>
                            <select id="userStatus" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>Comiss√£o:</strong> Percentual calculado sobre o lucro l√≠quido de cada venda. 
                            Exemplo: Lucro R$ 1.000 com 15% = R$ 150 de comiss√£o.
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Usu√°rio</button>
                        <button type="reset" class="btn btn-secondary">üîÑ Limpar</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üë•</span> Usu√°rios Cadastrados</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Cargo</th>
                            <th>Comiss√£o</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Servi√ßos Section -->
        <div id="servicos" class="content-section">
            <div class="form-card">
                <h3><span>üõ†Ô∏è</span> Cadastrar Servi√ßo</h3>
                <form id="serviceForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Servi√ßo <span>*</span></label>
                        <input type="text" id="serviceName" placeholder="Ex: Consignado INSS" required>
                    </div>
                    <div class="form-group">
                        <label>Moeda <span>*</span></label>
                        <select id="serviceCurrency" required>
                            <option value="BRL" selected>BRL - Real (R$)</option>
                            <option value="USD">USD - D√≥lar ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Custo <span>*</span></label>
                        <select id="costType" required onchange="toggleCostFields()">
                            <option value="">Selecione...</option>
                            <option value="fixo">Fixo (valor)</option>
                            <option value="percentual">Percentual (%)</option>
                            <option value="fixo_percentual">Fixo + Percentual</option>
                            <option value="cotacao_percentual">Cota√ß√£o + Percentual</option>
                        </select>
                    </div>
                        <div class="form-group" id="costFixoGroup" style="display: none;">
                            <label>Custo Fixo (R$) <span>*</span></label>
                            <input type="number" id="costFixo" placeholder="Ex: 20" min="0" step="0.01">
                        </div>
                        <div class="form-group" id="costPercentualGroup" style="display: none;">
                            <label>Custo Percentual (%) <span>*</span></label>
                            <input type="number" id="costPercentual" placeholder="Ex: 0.80" min="0" max="100" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Status <span>*</span></label>
                            <select id="serviceStatus" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>Tipos de Custo:</strong><br>
                            ‚Ä¢ <strong>Fixo:</strong> Valor fixo em reais (Ex: R$ 20,00)<br>
                            ‚Ä¢ <strong>Percentual:</strong> Percentual sobre o valor da venda (Ex: 0.80%)<br>
                            ‚Ä¢ <strong>Fixo + Percentual:</strong> Combina√ß√£o dos dois (Ex: R$ 20,00 + 0.80%)<br>
                            ‚Ä¢ <strong>Cota√ß√£o + Percentual:</strong> Usa a cota√ß√£o USDT no momento e aplica o percentual informado
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="serviceDescription" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Servi√ßo</button>
                        <button type="reset" class="btn btn-secondary">üîÑ Limpar</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üì¶</span> Servi√ßos Cadastrados</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Servi√ßo</th>
                            <th>Custo</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Atribuir Servi√ßos Section -->
        <div id="atribuir" class="content-section">
            <div class="form-card">
                <h3><span>üîó</span> Atribuir Servi√ßos a Usu√°rios</h3>
                <form id="assignForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Selecionar Usu√°rio <span>*</span></label>
                            <select id="assignUser" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Selecionar Servi√ßo <span>*</span></label>
                            <select id="assignService" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">‚ÑπÔ∏è</span>
                        <div class="info-box-text">
                            Atribua os servi√ßos que cada usu√°rio pode vender. Isso permite controlar quais produtos cada membro do time comercial tem acesso.
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üîó Atribuir Servi√ßo</button>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <h3><span>üìã</span> Servi√ßos Atribu√≠dos</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usu√°rio</th>
                            <th>Cargo</th>
                            <th>Servi√ßos Atribu√≠dos</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="assignmentsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Cota√ß√£o D√≥lar Section -->
        <div id="dolar" class="content-section">
            <div class="form-card">
                <h3><span>üí±</span> Configurar Cota√ß√£o do D√≥lar</h3>
                <form id="dolarForm">
                    <div class="form-group">
                        <label>Link da API de Cota√ß√£o <span>*</span></label>
                        <input type="url" id="dolarAPI" placeholder="https://economia.awesomeapi.com.br/last/USD-BRL" required>
                    </div>
                    <div class="info-box">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>APIs Sugeridas:</strong><br>
                            ‚Ä¢ AwesomeAPI: https://economia.awesomeapi.com.br/last/USD-BRL<br>
                            ‚Ä¢ BrasilAPI: https://brasilapi.com.br/api/v2/currency/USD<br>
                            ‚Ä¢ Banco Central: https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Salvar Configura√ß√£o</button>
                        <button type="button" class="btn btn-secondary" onclick="testDolarAPI()">üîç Testar API</button>
                    </div>
                </form>

                <div class="form-card" style="margin-top: 2rem;">
                    <h3><span>üìä</span> Cota√ß√£o Atual <button type="button" class="btn btn-primary" onclick="atualizarCotacao()" style="margin-left: 1rem; padding: 0.5rem 1rem;">üîÑ Atualizar</button></h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-title">USDT (Binance)</span>
                                <div class="kpi-icon profit">üí∞</div>
                            </div>
                            <div class="kpi-value profit-color" id="usdtPrice">R$ 5,54</div>
                            <div class="kpi-trend">
                                <span style="color: #10b981;">‚óè</span>
                                <span>Tempo real</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-title">√öltima Atualiza√ß√£o</span>
                                <div class="kpi-icon orders">üïê</div>
                            </div>
                            <div class="kpi-value" style="font-size: 1.5rem;" id="lastUpdate">--</div>
                            <div class="kpi-trend">
                                <span id="lastUpdateTime">--:--</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.875rem; margin-top: 1rem;">üí° Cota√ß√£o obtida diretamente da API p√∫blica da Binance (USDT/BRL)</p>
                </div>
            </div>
        </div>

        <!-- Ordens Abertas Section -->
        <div id="ordens-abertas" class="content-section">
            <div class="form-card">
                <h3><span>üìã</span> Ordens de Pagamento em Aberto</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Servi√ßo</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Comprovante</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="openOrdersTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Ordens Conclu√≠das Section -->
        <div id="ordens-concluidas" class="content-section">
            <div class="form-card">
                <h3><span>‚úÖ</span> Ordens de Pagamento Conclu√≠das</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Servi√ßo</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Comprovante</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="concludedOrdersTbody"></tbody>
                </table>
            </div>
        </div>
    </div>
        <!-- Comiss√µes Pendentes Section -->
        <div id="comissoes-pendentes" class="content-section">
            <div class="form-card narrow">
                <h3><span>üíµ</span> Comiss√µes Pendentes de Pagamento</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vendedor</th>
                            <th>Cargo</th>
                            <th>Total de Vendas</th>
                            <th>Lucro Gerado</th>
                            <th>Taxa</th>
                            <th>Comiss√£o a Pagar</th>
                            <th>Per√≠odo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="pendingCommissionsTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Comiss√µes Pagas Section -->
        <div id="comissoes-pagas" class="content-section">
            <div class="form-card narrow">
                <h3><span>‚úÖ</span> Comiss√µes Pagas</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vendedor</th>
                            <th>Cargo</th>
                            <th>Total de Vendas</th>
                            <th>Lucro Gerado</th>
                            <th>Taxa</th>
                            <th>Comiss√£o Paga</th>
                            <th>Per√≠odo</th>
                            <th>Data Pagamento</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="paidCommissionsTbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Usu√°rio -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Usu√°rio</h3>
                <button type="button" class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome completo <span>*</span></label>
                        <input type="text" id="editUserName" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail <span>*</span></label>
                        <input type="email" id="editUserEmail" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Telefone <span>*</span></label>
                        <input type="tel" id="editUserPhone" required autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label>Cargo <span>*</span></label>
                        <select id="editUserRole" required>
                            <option value="">Selecione...</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Gerente de Contas">Gerente de Contas</option>
                            <option value="Consultor Comercial">Consultor Comercial</option>
                            <option value="Executivo de Vendas">Executivo de Vendas</option>
                            <option value="Analista Comercial">Analista Comercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nova Senha</label>
                        <input type="password" id="editUserPassword" placeholder="Deixe em branco para manter" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Comiss√£o sobre Lucro (%) <span>*</span></label>
                        <input type="number" id="editUserCommission" placeholder="Ex: 15" min="0" max="100" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>Status <span>*</span></label>
                        <select id="editUserStatus" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 1rem;">
                    <span class="info-box-icon">‚ÑπÔ∏è</span>
                    <div class="info-box-text">
                        Atualize a senha apenas se desejar troc√°-la. Os demais campos tamb√©m sincronizam o login desse usu√°rio.
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Servi√ßo -->
    <div id="editServiceModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üõ†Ô∏è Editar Servi√ßo</h3>
                <button type="button" class="modal-close" onclick="closeEditServiceModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Atualize dados, moeda, custos e status do servi√ßo.</div>
            <form id="editServiceForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Servi√ßo <span>*</span></label>
                        <input type="text" id="editServiceName" required>
                    </div>
                    <div class="form-group">
                        <label>Moeda <span>*</span></label>
                        <select id="editServiceCurrency" required>
                            <option value="BRL">BRL - Real (R$)</option>
                            <option value="USD">USD - D√≥lar ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Custo <span>*</span></label>
                        <select id="editCostType" required onchange="toggleCostFieldsEdit()">
                            <option value="">Selecione...</option>
                            <option value="fixo">Fixo (valor)</option>
                            <option value="percentual">Percentual (%)</option>
                            <option value="fixo_percentual">Fixo + Percentual</option>
                            <option value="cotacao_percentual">Cota√ß√£o + Percentual</option>
                        </select>
                    </div>
                    <div class="form-group" id="editCostFixoGroup" style="display: none;">
                        <label>Custo Fixo</label>
                        <input type="number" id="editCostFixo" placeholder="Ex: 25" min="0" step="0.01">
                    </div>
                    <div class="form-group" id="editCostPercentualGroup" style="display: none;">
                        <label>Custo Percentual (%)</label>
                        <input type="number" id="editCostPercentual" placeholder="Ex: 0.8" min="0" max="100" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Status <span>*</span></label>
                        <select id="editServiceStatus" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="editServiceDescription" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditServiceModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Atribui√ß√µes -->
    <div id="editAssignmentsModal" class="modal-overlay">
        <div class="modal-card" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üîó Atribuir Servi√ßos ao Usu√°rio</h3>
                <button type="button" class="modal-close" onclick="closeEditAssignmentsModal()">&times;</button>
            </div>
            <div class="modal-subtitle" id="editAssignmentsUserInfo">Selecione os servi√ßos que este usu√°rio poder√° vender.</div>
            <form id="editAssignmentsForm">
                <div class="form-group">
                    <label>Servi√ßos dispon√≠veis</label>
                    <div id="assignServiceList" class="checkbox-list"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditAssignmentsModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Atribui√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Comprovante -->
    <div id="comprovanteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center;">
        <div style="position: relative; max-width: 90%; max-height: 90%; background: #1a1a1a; border-radius: 12px; padding: 2rem; border: 2px solid #D4AF37;">
            <button onclick="fecharModal()" style="position: absolute; top: 1rem; right: 1rem; background: #D4AF37; color: #0a0a0a; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; font-weight: bold;">&times;</button>
            <h3 style="color: #D4AF37; margin-bottom: 1rem; text-align: center;">üìé Detalhes da Ordem</h3>
            <div style="color: #ddd; margin-bottom: 1rem;">
                <p style="margin: 0.25rem 0;"><strong>Wallet:</strong> <span id="walletInfo">-</span></p>
            </div>
            <div style="text-align: center;">
                <img id="comprovanteImg" src="" alt="Comprovante" style="max-width: 100%; max-height: 65vh; border-radius: 8px; border: 1px solid #333; display: none;">
                <p id="comprovantePlaceholder" style="color: #888; font-size: 0.95rem; margin-top: 1rem;">Nenhum comprovante enviado.</p>
                <p style="color: #888; margin-top: 1rem; font-size: 0.875rem;">Clique no X para fechar</p>
            </div>
        </div>
    </div>

    <script>
        const apiBase = '';
        let cachedUsers = [];
        let cachedServices = [];
        let cachedOrders = [];
        let cachedAssignments = [];
        let currentFilter = 'month';
        let editingUserId = null;
        let editingServiceId = null;
        let editingAssignmentsUserId = null;

        function showSection(event, sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value,
                role: document.getElementById('userRole').value,
                commission: document.getElementById('userCommission').value,
                status: document.getElementById('userStatus').value,
                password: document.getElementById('userPassword').value || undefined
            };

            fetchJson('/api/users', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Usu√°rio cadastrado com sucesso!');
                this.reset();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('serviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('serviceName').value,
                currency: document.getElementById('serviceCurrency').value || 'BRL',
                costType: document.getElementById('costType').value,
                costFixo: document.getElementById('costFixo').value,
                costPercentual: document.getElementById('costPercentual').value,
                status: document.getElementById('serviceStatus').value,
                description: document.getElementById('serviceDescription').value
            };

            fetchJson('/api/services', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Servi√ßo cadastrado com sucesso!');
                this.reset();
                toggleCostFields();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('assignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                userId: Number(document.getElementById('assignUser').value),
                serviceId: Number(document.getElementById('assignService').value)
            };
            if (!payload.userId || !payload.serviceId) {
                alert('Selecione usu√°rio e servi√ßo.');
                return;
            }
            fetchJson('/api/assignments', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                alert('‚úÖ Servi√ßo atribu√≠do com sucesso!');
                this.reset();
                loadAdminData();
            }).catch(showError);
        });

        document.getElementById('dolarForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('‚úÖ Configura√ß√£o salva com sucesso!');
        });

        function testDolarAPI() {
            const apiUrl = document.getElementById('dolarAPI').value;
            if (!apiUrl) {
                alert('‚ö†Ô∏è Por favor, insira uma URL da API');
                return;
            }
            alert('üîç Testando API...\n\nResultado: Conex√£o bem-sucedida!\nCota√ß√£o: R$ 5,42');
        }

        function openEditUserModal(id) {
            const modal = document.getElementById('editUserModal');
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(id));
            if (!modal || !user) {
                alert('‚ö†Ô∏è Usu√°rio n√£o encontrado para edi√ß√£o.');
                return;
            }

            editingUserId = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserRole').value = user.role || '';
            document.getElementById('editUserCommission').value = user.commission ?? 0;
            document.getElementById('editUserStatus').value = user.status || 'Ativo';
            document.getElementById('editUserPassword').value = '';

            modal.style.display = 'flex';
        }

        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            editingUserId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditUserOverlay(event) {
            if (event.target.id === 'editUserModal') {
                closeEditUserModal();
            }
        }

        const editUserModalEl = document.getElementById('editUserModal');
        if (editUserModalEl) {
            editUserModalEl.addEventListener('click', handleEditUserOverlay);
        }

        function openEditServiceModal(id) {
            const modal = document.getElementById('editServiceModal');
            const service = (cachedServices || []).find(s => Number(s.id) === Number(id));
            if (!modal || !service) {
                alert('‚ö†Ô∏è Servi√ßo n√£o encontrado para edi√ß√£o.');
                return;
            }

            editingServiceId = service.id;
            document.getElementById('editServiceName').value = service.name || '';
            document.getElementById('editServiceCurrency').value = (service.currency || 'BRL').toUpperCase();
            document.getElementById('editCostType').value = service.costType || '';
            document.getElementById('editCostFixo').value = service.costFixo ?? '';
            document.getElementById('editCostPercentual').value = service.costPercentual ?? '';
            document.getElementById('editServiceStatus').value = service.status || 'Ativo';
            document.getElementById('editServiceDescription').value = service.description || '';
            toggleCostFieldsEdit();

            modal.style.display = 'flex';
        }

        function closeEditServiceModal() {
            const modal = document.getElementById('editServiceModal');
            const form = document.getElementById('editServiceForm');
            editingServiceId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditServiceOverlay(event) {
            if (event.target.id === 'editServiceModal') {
                closeEditServiceModal();
            }
        }

        const editServiceModalEl = document.getElementById('editServiceModal');
            if (editServiceModalEl) {
            editServiceModalEl.addEventListener('click', handleEditServiceOverlay);
        }

        function toggleCostFieldsEdit() {
            const costType = document.getElementById('editCostType').value;
            const fixoGroup = document.getElementById('editCostFixoGroup');
            const percentualGroup = document.getElementById('editCostPercentualGroup');
            const fixoInput = document.getElementById('editCostFixo');
            const percentualInput = document.getElementById('editCostPercentual');

            fixoGroup.style.display = 'none';
            percentualGroup.style.display = 'none';
            fixoInput.removeAttribute('required');
            percentualInput.removeAttribute('required');

            if (costType === 'fixo') {
                fixoGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
            } else if (costType === 'percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'fixo_percentual') {
                fixoGroup.style.display = 'flex';
                percentualGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'cotacao_percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            }
        }

        document.getElementById('editServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingServiceId) {
                alert('Nenhum servi√ßo selecionado para edi√ß√£o.');
                return;
            }

            const payload = {
                name: document.getElementById('editServiceName').value,
                currency: document.getElementById('editServiceCurrency').value,
                costType: document.getElementById('editCostType').value,
                costFixo: document.getElementById('editCostFixo').value,
                costPercentual: document.getElementById('editCostPercentual').value,
                status: document.getElementById('editServiceStatus').value,
                description: document.getElementById('editServiceDescription').value
            };

            try {
                await fetchJson(`/api/services/${editingServiceId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('‚úÖ Servi√ßo atualizado com sucesso!');
                closeEditServiceModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        function openEditAssignmentsModal(userId) {
            const modal = document.getElementById('editAssignmentsModal');
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(userId));
            if (!modal || !user) {
                alert('‚ö†Ô∏è Usu√°rio n√£o encontrado para atribui√ß√£o.');
                return;
            }

            editingAssignmentsUserId = user.id;
            const infoEl = document.getElementById('editAssignmentsUserInfo');
            if (infoEl) infoEl.textContent = `Selecione os servi√ßos para ${user.name} (${user.role || 'Sem cargo'})`;

            const currentServices = new Set(
                (cachedAssignments || [])
                    .filter(a => Number(a.userId ?? a.userid) === Number(userId))
                    .map(a => Number(a.serviceId ?? a.serviceid))
            );

            const listEl = document.getElementById('assignServiceList');
            listEl.innerHTML = '';

            if (!cachedServices.length) {
                listEl.innerHTML = '<p style="color:#aaa;">Nenhum servi√ßo cadastrado.</p>';
            } else {
                cachedServices.forEach(service => {
                    const id = service.id;
                    const checkboxId = `assign-service-${id}`;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'checkbox-item';
                    wrapper.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${id}" ${currentServices.has(id) ? 'checked' : ''}>
                        <label for="${checkboxId}">${service.name} ${service.status === 'Inativo' ? '(Inativo)' : ''}</label>
                    `;
                    listEl.appendChild(wrapper);
                });
            }

            modal.style.display = 'flex';
        }

        function closeEditAssignmentsModal() {
            const modal = document.getElementById('editAssignmentsModal');
            const form = document.getElementById('editAssignmentsForm');
            editingAssignmentsUserId = null;
            if (form) form.reset();
            if (modal) modal.style.display = 'none';
        }

        function handleEditAssignmentsOverlay(event) {
            if (event.target.id === 'editAssignmentsModal') {
                closeEditAssignmentsModal();
            }
        }

        const editAssignmentsModalEl = document.getElementById('editAssignmentsModal');
        if (editAssignmentsModalEl) {
            editAssignmentsModalEl.addEventListener('click', handleEditAssignmentsOverlay);
        }

        document.getElementById('editAssignmentsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingAssignmentsUserId) {
                alert('Nenhum usu√°rio selecionado para atribuir.');
                return;
            }

            const selectedServiceIds = Array.from(document.querySelectorAll('#assignServiceList input[type="checkbox"]:checked'))
                .map(input => Number(input.value));

            const currentAssignments = (cachedAssignments || []).filter(a => Number(a.userId ?? a.userid) === Number(editingAssignmentsUserId));
            const currentServiceIds = new Set(currentAssignments.map(a => Number(a.serviceId ?? a.serviceid)));
            const assignmentIdByService = currentAssignments.reduce((acc, a) => {
                const sid = Number(a.serviceId ?? a.serviceid);
                acc[sid] = a.id;
                return acc;
            }, {});

            const toAdd = selectedServiceIds.filter(id => !currentServiceIds.has(id));
            const toRemove = Array.from(currentServiceIds).filter(id => !selectedServiceIds.includes(id));

            try {
                await Promise.all(toAdd.map(serviceId => fetchJson('/api/assignments', {
                    method: 'POST',
                    body: JSON.stringify({ userId: editingAssignmentsUserId, serviceId })
                })));

                for (const serviceId of toRemove) {
                    const assignId = assignmentIdByService[serviceId];
                    if (assignId) {
                        await fetchJson(`/api/assignments/${assignId}`, { method: 'DELETE' });
                    }
                }

                alert('‚úÖ Atribui√ß√µes atualizadas com sucesso!');
                closeEditAssignmentsModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingUserId) {
                alert('Nenhum usu√°rio selecionado para edi√ß√£o.');
                return;
            }

            const commissionValue = parseFloat(document.getElementById('editUserCommission').value);
            const password = document.getElementById('editUserPassword').value;

            const payload = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                phone: document.getElementById('editUserPhone').value,
                role: document.getElementById('editUserRole').value,
                commission: Number.isFinite(commissionValue) ? commissionValue : 0,
                status: document.getElementById('editUserStatus').value
            };

            try {
                await fetchJson(`/api/users/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });

                await fetchJson(`/api/users/${editingUserId}/credentials`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        email: payload.email,
                        role: payload.role,
                        password: password || undefined
                    })
                });

                alert('‚úÖ Usu√°rio atualizado com sucesso!');
                closeEditUserModal();
                loadAdminData();
            } catch (err) {
                showError(err);
            }
        });

        function concluirOrdem(id) {
            if (!confirm('Deseja marcar esta ordem como conclu√≠da?')) return;
            fetchJson(`/api/orders/${id}/status`, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'concluded' })
            }).then(() => {
                alert(`‚úÖ Ordem #${id} conclu√≠da com sucesso!`);
                loadAdminData();
            }).catch(showError);
        }

        function verComprovante(id) {
            const modal = document.getElementById('comprovanteModal');
            const order = (cachedOrders || []).find(o => Number(o.id) === Number(id));
            const walletEl = document.getElementById('walletInfo');
            const imgEl = document.getElementById('comprovanteImg');
            const placeholderEl = document.getElementById('comprovantePlaceholder');

            walletEl.textContent = order?.wallet || '-';

            if (order?.payoutProof) {
                imgEl.style.display = 'block';
                imgEl.src = order.payoutProof;
                placeholderEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                placeholderEl.style.display = 'block';
            }

            modal.style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('comprovanteModal').style.display = 'none';
        }

        async function atualizarCotacao() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL');
                const data = await response.json();

                if (data && data.price) {
                    const price = parseFloat(data.price).toFixed(4);
                    document.getElementById('usdtPrice').textContent = 'R$ ' + price.replace('.', ',');
                    const topPriceEl = document.getElementById('topUsdtPrice');
                    if (topPriceEl) {
                        topPriceEl.textContent = 'R$ ' + price.replace('.', ',');
                    }

                    const now = new Date();
                    const dateStr = now.toLocaleDateString('pt-BR');
                    const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('lastUpdate').textContent = dateStr;
                    document.getElementById('lastUpdateTime').textContent = timeStr;

                    console.log('Cota√ß√£o USDT atualizada:', price);
                } else {
                    alert('‚ö†Ô∏è Erro ao buscar cota√ß√£o da Binance');
                }
            } catch (error) {
                console.error('Erro ao buscar cota√ß√£o:', error);
                alert('‚ö†Ô∏è Erro ao conectar com a API da Binance');
            }
        }

        function attachPhoneMask(elementId) {
            const input = document.getElementById(elementId);
            if (!input) return;
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);

                if (value.length > 6) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
                } else if (value.length > 2) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
                }

                e.target.value = value;
            });
        }

        attachPhoneMask('userPhone');
        attachPhoneMask('editUserPhone');

        function toggleCostFields() {
            const costType = document.getElementById('costType').value;
            const fixoGroup = document.getElementById('costFixoGroup');
            const percentualGroup = document.getElementById('costPercentualGroup');
            const fixoInput = document.getElementById('costFixo');
            const percentualInput = document.getElementById('costPercentual');

            fixoGroup.style.display = 'none';
            percentualGroup.style.display = 'none';
            fixoInput.removeAttribute('required');
            percentualInput.removeAttribute('required');

            if (costType === 'fixo') {
                fixoGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
            } else if (costType === 'percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'fixo_percentual') {
                fixoGroup.style.display = 'flex';
                percentualGroup.style.display = 'flex';
                fixoInput.setAttribute('required', 'required');
                percentualInput.setAttribute('required', 'required');
            } else if (costType === 'cotacao_percentual') {
                percentualGroup.style.display = 'flex';
                percentualInput.setAttribute('required', 'required');
            }
        }

        function darBaixaComissao(id, vendedor, valor) {
            if (confirm(`Confirmar pagamento da comiss√£o de R$ ${valor.toFixed(2).replace('.', ',')} para ${vendedor}?`)) {
                fetchJson(`/api/orders/${id}/commission`, {
                    method: 'PATCH',
                    body: JSON.stringify({ commissionPaid: true })
                }).then(() => {
                    alert(`‚úÖ Comiss√£o #${id} paga com sucesso!`);
                    loadAdminData();
                }).catch(showError);
            }
        }

        function showError(err) {
            console.error(err);
            alert('‚ö†Ô∏è Erro: ' + (err?.message || 'n√£o foi poss√≠vel completar a a√ß√£o'));
        }

        async function fetchJson(path, options = {}) {
            const res = await fetch(apiBase + path, {
                headers: { 'Content-Type': 'application/json' },
                cache: 'no-store',
                ...options
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || res.statusText);
            }
            return res.status === 204 ? null : res.json();
        }

        function formatBRL(value) {
            return (value ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
        }

        function formatBRL4(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4, maximumFractionDigits: 4 });
        }

        function formatCurrencyValue(currency, value) {
            const num = Number(value ?? 0);
            if (!Number.isFinite(num)) return value ?? '-';
            if ((currency || '').toUpperCase() === 'USD') {
                return '$ ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return formatBRL(num);
        }

        function formatDate(value) {
            if (!value) return '--';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return d.toLocaleDateString('pt-BR');
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role || '--'}</td>
                    <td><span class=\"badge badge-gold\">${(user.commission ?? 0)}%</span></td>
                    <td><span class=\"badge ${user.status === 'Ativo' ? 'badge-success' : 'badge-warning'}\">${user.status}</span></td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar\" onclick=\"openEditUserModal(${user.id})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Excluir\" onclick=\"deleteUser(${user.id})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderServices(services) {
            const tbody = document.getElementById('servicesTableBody') || document.querySelector('#servicesTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            services.forEach(service => {
                const currency = (service.currency || 'BRL').toUpperCase();
                const fixedValue = formatCurrencyValue(currency, service.costFixo);
                const costLabel = service.costType === 'fixo' ? fixedValue :
                    service.costType === 'percentual' ? `${service.costPercentual}%` :
                    service.costType === 'fixo_percentual' ? `${fixedValue} + ${service.costPercentual}%` :
                    `Cota√ß√£o (${currency}) + ${service.costPercentual}%`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${service.name}</td>
                    <td>${costLabel}</td>
                    <td><span class=\"badge ${service.status === 'Ativo' ? 'badge-success' : 'badge-warning'}\">${service.status}</span></td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar\" onclick=\"openEditServiceModal(${service.id})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Excluir\" onclick=\"deleteService(${service.id})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateAssignSelects(users, services) {
            const userSelect = document.getElementById('assignUser');
            const serviceSelect = document.getElementById('assignService');
            if (!userSelect || !serviceSelect) return;
            userSelect.innerHTML = '<option value=\"\">Selecione...</option>';
            serviceSelect.innerHTML = '<option value=\"\">Selecione...</option>';

            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = `${u.name} (${u.role || 'Sem cargo'})`;
                userSelect.appendChild(opt);
            });

            services.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                serviceSelect.appendChild(opt);
            });
        }

        function renderAssignments(assignments) {
            const tbody = document.getElementById('assignmentsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!assignments.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan=\"4\" style=\"text-align:center; color:#aaa;\">Nenhum servi√ßo atribu√≠do.</td>`;
                tbody.appendChild(tr);
                return;
            }

            // Agrupa servi√ßos por usu√°rio
            const grouped = assignments.reduce((acc, item) => {
                const userId = item.userId ?? item.userid;
                if (!userId) return acc;
                if (!acc[userId]) {
                    acc[userId] = {
                        userId,
                        username: item.username || '‚Äî',
                        role: item.role || '-',
                        services: [],
                        serviceIds: [],
                        assignmentIds: {}
                    };
                }
                const serviceName = item.serviceName || item.servicename || '-';
                const serviceId = item.serviceId ?? item.serviceid;
                acc[userId].services.push(serviceName);
                if (serviceId) acc[userId].serviceIds.push(serviceId);
                if (serviceId && item.id) acc[userId].assignmentIds[serviceId] = item.id;
                return acc;
            }, {});

            Object.values(grouped).forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${user.services.join(', ')}</td>
                    <td>
                        <button class=\"btn-icon btn-edit\" title=\"Editar servi√ßos\" onclick=\"openEditAssignmentsModal(${user.userId})\">‚úèÔ∏è</button>
                        <button class=\"btn-icon btn-delete\" title=\"Remover todos\" onclick=\"removeAllAssignmentsForUser(${user.userId})\">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterOrdersByPeriod(orders, period) {
            if (!orders || !orders.length) return [];
            const now = new Date();
            const start = new Date();
            if (period === 'today') start.setHours(0, 0, 0, 0);
            if (period === 'week') start.setDate(now.getDate() - 7);
            if (period === 'month') start.setDate(now.getDate() - 30);
            return orders.filter(o => {
                const d = new Date(o.date || o.created_at || now);
                if (Number.isNaN(d.getTime())) return true;
                if (period === 'today') return d.toDateString() === now.toDateString();
                return d >= start;
            });
        }

        function renderOrders(orders, users, services) {
            const usersMap = Object.fromEntries(users.map(u => [u.id, u]));
            const servicesMap = Object.fromEntries(services.map(s => [s.id, s]));

            const openTbody = document.getElementById('openOrdersTbody');
            const concludedTbody = document.getElementById('concludedOrdersTbody');
            if (openTbody) openTbody.innerHTML = '';
            if (concludedTbody) concludedTbody.innerHTML = '';

            const pendingCommissionsTbody = document.getElementById('pendingCommissionsTbody');
            const paidCommissionsTbody = document.getElementById('paidCommissionsTbody');
            if (pendingCommissionsTbody) pendingCommissionsTbody.innerHTML = '';
            if (paidCommissionsTbody) paidCommissionsTbody.innerHTML = '';

            orders.forEach(order => {
                const seller = usersMap[order.sellerId];
                const service = servicesMap[order.serviceId];
                const serviceName = service?.name || order.productType || 'Servi√ßo';
                const sellerName = seller?.name || '‚Äî';
                const commissionValue = order.commissionValue ?? 0;
                const status = order.status || 'open';
                const unitPriceDisplay = Number(order.unitPrice) || (order.price && order.quantity ? Number(order.price) / Number(order.quantity) : null);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${order.id}${order.isRetroactive ? ' <span class="badge" style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); font-size: 0.65rem;">üìÖ RETRO</span>' : ''}</td>
                    <td>${order.customer || '-'}</td>
                    <td>${sellerName}</td>
                    <td><span class=\"badge badge-gold\">${serviceName}</span></td>
                    <td>${order.quantity != null ? order.quantity : '-'}</td>
                    <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                    <td>${order.wallet ? `<span title=\"${order.wallet}\">${order.wallet}</span>` : '-'}</td>
                    <td>${formatBRL(order.price)}</td>
                    <td>${formatBRL(order.cost)}</td>
                    <td class=\"profit-color\">${formatBRL(order.profit)}</td>
                    <td class=\"profit-color\">${formatBRL(commissionValue)}</td>
                    <td title="${order.historicalQuote ? 'Cota√ß√£o hist√≥rica: R$ ' + Number(order.historicalQuote).toFixed(4) : 'Cota√ß√£o autom√°tica'}">${formatDate(order.date)}</td>
                    <td>${order.payoutProof ? `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"verComprovante(${order.id})\">üìé Ver</button>` : '-'}</td>
                    <td>${status === 'open' ? `<button class=\"btn btn-primary\" style=\"padding: 0.5rem 1rem; font-size: 0.875rem;\" onclick=\"concluirOrdem(${order.id})\">‚úÖ Concluir</button>` : '<span class=\"badge badge-success\">Conclu√≠da</span>'}</td>
                `;

                if (status === 'open' && openTbody) openTbody.appendChild(tr);
                if (status === 'concluded' && concludedTbody) concludedTbody.appendChild(tr.cloneNode(true));

                if (status === 'concluded') {
                    const commTr = document.createElement('tr');
                    commTr.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${sellerName}</td>
                        <td>${seller?.role || '-'}</td>
                        <td>${order.quantity != null ? order.quantity : '-'}</td>
                        <td>${order.salesCount || '-'}</td>
                        <td class=\"profit-color\">${formatBRL(order.profit)}</td>
                        <td>${(seller?.commission ?? 0)}%</td>
                        <td class=\"profit-color\" style=\"font-weight: 700; font-size: 1.1rem;\">${formatBRL(commissionValue)}</td>
                        <td>${new Date(order.date || Date.now()).toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</td>
                        <td>
                            ${order.commissionPaid ? '<span class=\"badge badge-success\">Pago</span>' : `<button class=\"btn btn-success\" onclick=\"darBaixaComissao(${order.id}, '${sellerName}', ${commissionValue})\" style=\"padding: 0.5rem 1rem;\">‚úÖ Dar Baixa</button>`}
                        </td>
                    `;
                    if (!order.commissionPaid && pendingCommissionsTbody) pendingCommissionsTbody.appendChild(commTr);
                    if (order.commissionPaid && paidCommissionsTbody) paidCommissionsTbody.appendChild(commTr.cloneNode(true));
                }
            });
        }

        async function deleteUser(id) {
            if (!confirm('Deseja excluir este usu√°rio?')) return;
            await fetchJson(`/api/users/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function deleteService(id) {
            if (!confirm('Deseja excluir este servi√ßo?')) return;
            await fetchJson(`/api/services/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function deleteAssignment(id) {
            if (!confirm('Remover este servi√ßo atribu√≠do?')) return;
            await fetchJson(`/api/assignments/${id}`, { method: 'DELETE' });
            loadAdminData();
        }

        async function removeAllAssignmentsForUser(userId) {
            const user = (cachedUsers || []).find(u => Number(u.id) === Number(userId));
            if (!user) return;
            if (!confirm(`Remover todas as atribui√ß√µes de ${user.name}?`)) return;
            const assignments = (cachedAssignments || []).filter(a => Number(a.userId ?? a.userid) === Number(userId));
            for (const assign of assignments) {
                await fetchJson(`/api/assignments/${assign.id}`, { method: 'DELETE' });
            }
            loadAdminData();
        }

        async function loadAdminData() {
            try {
                const results = await Promise.allSettled([
                    fetchJson('/api/users'),
                    fetchJson('/api/services'),
                    fetchJson('/api/orders'),
                    fetchJson('/api/assignments')
                ]);

                const users = results[0].status === 'fulfilled' ? results[0].value : [];
                const services = results[1].status === 'fulfilled' ? results[1].value : [];
                const orders = results[2].status === 'fulfilled' ? results[2].value : [];
                const assignments = results[3].status === 'fulfilled' ? results[3].value : [];

                cachedUsers = users;
                cachedServices = services;
                cachedOrders = orders;
                cachedAssignments = assignments;
                renderUsers(users);
                renderServices(services);
                updateAssignSelects(users, services);
                renderAssignments(assignments);
                applyFilterAndRender();

                const failed = results.filter(r => r.status === 'rejected');
                if (failed.length) {
                    console.warn('Algumas fontes falharam ao carregar:', failed.map(f => f.reason?.message || f.reason));
                }
            } catch (err) {
                showError(err);
            }
        }

        window.addEventListener('load', function() {
            atualizarCotacao();
            setFilter('month');
            loadAdminData();
        });

        function setFilter(period) {
            currentFilter = period;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const index = period === 'today' ? 0 : period === 'week' ? 1 : 2;
            const btn = document.querySelectorAll('.filter-btn')[index];
            if (btn) btn.classList.add('active');
            applyFilterAndRender();
        }

        function applyFilterAndRender() {
            const filteredOrders = filterOrdersByPeriod(cachedOrders, currentFilter);
            renderOrders(filteredOrders, cachedUsers, cachedServices);
        }
    </script>
</body>
</html>
