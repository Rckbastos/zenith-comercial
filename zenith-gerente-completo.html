<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Comercial - Dashboard Gerente</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zenith">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D4AF37">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="zenith-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="pwa.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
    }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #D4AF37;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 60px;
            height: 60px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #D4AF37;
        }

        .header-title p {
            font-size: 0.95rem;
            color: #888;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(212, 175, 55, 0.1);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #D4AF37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #0a0a0a;
            font-size: 1.125rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: #888;
        }

        .top-info-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #1a3a52 0%, #0a2a42 100%);
            border-bottom: 2px solid #D4AF37;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .top-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-info-label {
            color: #D4AF37;
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
        }

        .top-info-value {
            color: #fff;
            font-weight: 700;
            font-size: 1.15rem;
            white-space: nowrap;
        }

        /* Container */
        .container {
            width: 65%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        /* Navigation Tabs */
        .nav-tabs {
            width: 100%;
            max-width: 100%;
            margin: 0 auto 2rem auto;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0 1rem;
            box-sizing: border-box;
            background: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
            position: static;
            box-shadow: none;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #c8c8c8;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.08);
        }

        .nav-tab.active {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.12);
            border-bottom: 2px solid #D4AF37;
        }

        /* Content Sections */
        .content-section {
            display: none;
            width: 100%;
            padding: 0;
            margin: 0 auto;
        }

        .content-section.active {
            display: block;
        }

        /* Commission Banner */
        .commission-banner {
            background: linear-gradient(135deg, #D4AF37 0%, #b8941f 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .commission-info {
            flex: 1;
            min-width: 250px;
        }

        .commission-label {
            font-size: 0.875rem;
            color: rgba(10, 10, 10, 0.7);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .commission-value {
            font-size: 3rem;
            font-weight: 700;
            color: #0a0a0a;
        }

        .commission-details {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .commission-detail {
            display: flex;
            flex-direction: column;
        }

        .commission-detail-label {
            font-size: 0.75rem;
            color: rgba(10, 10, 10, 0.6);
            font-weight: 500;
        }

        .commission-detail-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0a0a0a;
        }

        .commission-icon {
            font-size: 4rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #D4AF37;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.95rem;
            color: #888;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: #888;
        }

        /* Form Styles */
        .form-card,
        .form-card.wide-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin: 0 auto 2rem auto;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
            overflow-x: visible;
            overflow-y: visible;
        }

        .form-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #D4AF37;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 1rem;
            font-weight: 600;
            color: #ddd;
        }

        .form-group label span {
            color: #D4AF37;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.875rem 1rem;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.1);
            border: 2px dashed rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #D4AF37;
            font-weight: 500;
        }

        .file-upload-label:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        .file-name {
            font-size: 0.875rem;
            color: #10b981;
            margin-top: 0.5rem;
        }

        .info-box {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .info-box-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box-text {
            font-size: 0.875rem;
            color: #D4AF37;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #b8941f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        /* Container das tabelas */
        .form-card {
            width: 100% !important;
            max-width: 100% !important;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin: 0 auto 2rem auto;
            box-sizing: border-box;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
        }

        .form-card.wide-card {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 auto 2rem auto;
            height: auto;
            min-height: fit-content;
            max-height: none;
            overflow: visible;
        }

        /* Tabela base */
        .data-table {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            font-size: 1rem;
            background: #0a0a0a;
            border-radius: 8px;
            overflow: visible;
        }

        /* Cabe√ßalho da tabela */
        .data-table thead {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 1.25rem 1rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 700;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #D4AF37;
            white-space: nowrap;
            word-break: keep-all;
            overflow-wrap: normal;
            background: #1a1a1a;
            box-sizing: border-box;
        }

        /* C√©lulas da tabela */
        .data-table td {
            padding: 1.25rem 1rem;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 500;
            color: #ffffff;
            border-bottom: 1px solid #222;
            white-space: nowrap;
            word-break: keep-all;
            overflow-wrap: normal;
            background: #0a0a0a;
            box-sizing: border-box;
        }

        /* Hover nas linhas */
        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.08) !important;
        }

        .data-table tbody tr:hover td {
            background: rgba(212, 175, 55, 0.08) !important;
        }

        /* √öltima linha sem borda */
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mostrar texto completo */
        .data-table th,
        .data-table td {
            overflow: visible;
            text-overflow: clip;
            white-space: normal;
            word-break: break-word;
        }

        /* Alinhamentos espec√≠ficos */
        .data-table td:has(.badge) {
            text-align: center;
        }

        .profit-color,
        .profit-value {
            color: #10b981 !important;
            font-weight: 600;
        }

        /* Bot√µes dentro das tabelas */
        .data-table .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .data-table .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .badge-pending {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .badge-gold {
            background: rgba(212, 175, 55, 0.15);
            color: #D4AF37;
            border: 1px solid rgba(212, 175, 55, 0.4);
        }

        /* Larguras m√≠nimas por coluna */
        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 80px;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            min-width: 140px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            min-width: 140px;
        }

        /* Wallet */
        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            min-width: 220px;
            word-break: break-all;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            min-width: 200px;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            min-width: 140px;
            text-align: center;
        }

        /* Responsividade */
        @media screen and (min-width: 1600px) {
            .container {
                width: 95%;
                max-width: 2400px;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 1600px) {
            .container {
                width: 75%;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 1400px) {
            .container {
                width: 85%;
                margin: 0 auto;
            }
            .data-table {
                font-size: 0.9rem;
            }
            .data-table th {
                font-size: 0.8rem;
                padding: 1rem 0.75rem;
            }
            .data-table td {
                padding: 1rem 0.75rem;
            }
        }

        @media screen and (max-width: 1200px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
        }

        @media screen and (max-width: 992px) {
            .container {
                width: 100%;
                padding: 1rem 0.5rem;
            }
            .nav-tabs {
                width: 100%;
            }
            .data-table {
                min-width: 0;
            }
            .orders-table {
                min-width: 0;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                width: 100%;
                padding: 1rem 0.5rem;
            }
            .data-table {
                font-size: 0.85rem;
            }
            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
            .header {
                padding: 1rem;
            }
            .commission-banner {
                padding: 1.5rem;
            }
            .commission-value {
                font-size: 2rem;
            }
            .commission-icon {
                display: none;
            }
            .stats-grid,
            .form-grid {
                grid-template-columns: 1fr;
            }
            .nav-tabs {
                overflow-x: scroll;
            }
            .nav-tab {
                padding: 0.65rem 1rem;
                font-size: 0.95rem;
            }
            .btn,
            .btn-primary,
            .btn-secondary {
                padding: 0.65rem 1rem;
                font-size: 0.95rem;
            }
            .form-card {
                padding: 2rem;
            }
            .form-card h3 {
                font-size: 1.35rem;
            }
        }

        /* Backgrounds consolidados */
        .data-table thead tr {
            background: #1a1a1a !important;
        }

        .data-table tbody tr {
            background: #0a0a0a !important;
        }

        .data-table tbody tr:nth-child(even) {
            background: #0f0f0f !important;
        }

        /* Date picker custom */
        .date-picker-wrapper {
            position: relative;
            width: 100%;
        }

        .date-picker-wrapper input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 0.75rem;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-picker-wrapper input:hover {
            border-color: #D4AF37;
        }

        .date-picker-wrapper input:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .calendar-toggle {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #D4AF37;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .calendar-toggle:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .calendar-toggle svg {
            width: 20px;
            height: 20px;
        }

        .calendar-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            width: 100%;
            min-width: 320px;
            background: #1a1a1a;
            border: 2px solid #D4AF37;
            border-radius: 12px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
            display: none;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #333;
        }

        .calendar-month-year {
            color: #D4AF37;
            font-weight: 600;
            font-size: 1rem;
        }

        .calendar-nav {
            background: transparent;
            border: 1px solid #444;
            color: #D4AF37;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #D4AF37;
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .calendar-days-header span {
            text-align: center;
            color: #888;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #ddd;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #D4AF37;
        }

        .calendar-day.other-month { color: #555; }
        .calendar-day.today {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
            font-weight: 600;
        }
        .calendar-day.selected {
            background: #D4AF37;
            color: #0a0a0a;
            font-weight: 700;
        }
        .calendar-day.disabled {
            color: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .calendar-day.disabled:hover {
            background: transparent;
            border-color: transparent;
        }

        .profit-value {
            color: #10b981 !important;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .modal-card {
            background: #0f0f14;
            border: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 12px;
            padding: 1.75rem;
            width: min(900px, 94vw);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.55);
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-close {
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: #D4AF37;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #D4AF37;
            color: #0a0a0a;
        }

        .modal-comprovante {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-comprovante .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .comprovante-info {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #444;
        }

        .comprovante-info p {
            margin: 0;
            color: #ddd;
        }

        .comprovante-info strong {
            color: #D4AF37;
        }

        .comprovante-image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: #0a0a0a;
            border-radius: 8px;
            border: 2px solid #333;
            padding: 1rem;
        }

        .comprovante-image-container img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .comprovante-placeholder {
            color: #888;
            font-size: 1.1rem;
            text-align: center;
        }

        .modal-comprovante .modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #333;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Barra Fixa de Cota√ß√£o -->
    <div class="top-info-bar">
        <div class="top-info-item">
            <span class="top-info-label">üí∞ D√≥lar:</span>
            <span id="topUsdtPrice" class="top-info-value">R$ --</span>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo">
                <img src="zenith-logo.png" alt="Zenith Logo">
            </div>
            <div class="header-title">
                <h1>Zenith Comercial</h1>
                <p>Dashboard do Gerente</p>
            </div>
        </div>
        <div class="user-info" id="userMenuTrigger" style="cursor: pointer; position: relative;">
            <div class="user-avatar" id="userAvatar">JS</div>
            <div class="user-details">
                <span class="user-name" id="userName">Usu√°rio</span>
                <span class="user-role" id="userRole">Cargo ‚Ä¢ Comiss√£o</span>
            </div>
            <div id="userMenu" style="display:none; position:absolute; right:0; top:64px; background:#111; border:1px solid #2a2a2a; border-radius:12px; min-width:220px; box-shadow:0 10px 30px rgba(0,0,0,0.35); z-index:999;">
                <button class="nav-tab" style="width:100%; text-align:left; border:none; background:transparent; padding:0.75rem 1rem; color:#eaeaea;" onclick="openProfileModal()">üë§ Perfil</button>
                <button class="nav-tab" style="width:100%; text-align:left; border:none; background:transparent; padding:0.75rem 1rem; color:#eaeaea;" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection(event, 'dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection(event, 'nova-ordem')">‚ûï Nova Ordem</button>
            <button class="nav-tab" onclick="showSection(event, 'em-analise')">‚è≥ Em An√°lise</button>
            <button class="nav-tab" onclick="showSection(event, 'concluidas')">‚úÖ Conclu√≠das</button>
            <button class="nav-tab" onclick="showSection(event, 'minhas-vendas')">üìã Minhas Vendas</button>
            <button class="nav-tab" onclick="loadGerenteData()">üîÑ Atualizar</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <!-- Commission Banner -->
            <div class="commission-banner">
                <div class="commission-info">
                    <div class="commission-label">üí∞ COMISS√ÉO A RECEBER</div>
                    <div class="commission-value" id="bannerCommission">R$ 0,00</div>
                    <div class="commission-details">
                        <div class="commission-detail">
                            <span class="commission-detail-label">Lucro Gerado</span>
                            <span class="commission-detail-value" id="bannerProfit">R$ 0,00</span>
                        </div>
                        <div class="commission-detail">
                            <span class="commission-detail-label">Vendas</span>
                            <span class="commission-detail-value" id="bannerSales">0 vendas</span>
                        </div>
                    </div>
                </div>
                <div class="commission-icon">üíé</div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Vendas do M√™s</span>
                        <span class="stat-icon">üìä</span>
                    </div>
                    <div class="stat-value" id="vendasMes">0</div>
                    <div class="stat-subtitle" id="vendasMesSubtitle">--</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Ticket M√©dio</span>
                        <span class="stat-icon">üíµ</span>
                    </div>
                    <div class="stat-value" id="ticketMedio">R$ 0,00</div>
                    <div class="stat-subtitle">Valor m√©dio por venda</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Em An√°lise</span>
                        <span class="stat-icon">‚è≥</span>
                    </div>
                    <div class="stat-value" id="emAnalise">0</div>
                    <div class="stat-subtitle">Aguardando aprova√ß√£o</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Taxa de Aprova√ß√£o</span>
                        <span class="stat-icon">‚úÖ</span>
                    </div>
                    <div class="stat-value" id="taxaAprovacao">0%</div>
                    <div class="stat-subtitle" id="taxaAprovacaoSub">Ordens aprovadas</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #1a3a52 0%, #0a2a42 100%); border: 2px solid #D4AF37;">
                    <div class="stat-header">
                        <span class="stat-title">USDT (Binance)</span>
                        <span class="stat-icon">üí∞</span>
                    </div>
                    <div class="stat-value" id="usdtPriceGerente" style="color: #D4AF37;">R$ 5,54</div>
                    <div class="stat-subtitle" style="color: #10b981;">‚óè Tempo real</div>
                </div>
            </div>
        </div>

        <!-- Nova Ordem Section -->
        <div id="nova-ordem" class="content-section">
            <div class="form-card">
                <h3><span>‚ûï</span> Criar Nova Ordem de Pagamento</h3>
                <form id="orderForm">
                    <div class="info-box" style="margin-bottom: 1.5rem;">
                        <span class="info-box-icon">üí°</span>
                        <div class="info-box-text">
                            <strong>Ordem Retroativa:</strong> Use para registrar vendas com cota√ß√£o do dia do fechamento. Se informar a cota√ß√£o hist√≥rica, usaremos essa cota√ß√£o; se deixar vazio, buscamos a cota√ß√£o atual.
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data da Venda <span>*</span></label>
                            <div class="date-picker-wrapper">
                                <input type="text" id="orderDate" placeholder="dd/mm/aaaa" required readonly>
                                <button type="button" class="calendar-toggle" id="calendarToggle">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM16 2v4M8 2v4M3 10h18"/>
                                    </svg>
                                </button>
                                <div class="calendar-dropdown" id="calendarDropdown" style="display: none;">
                                    <div class="calendar-header">
                                        <button type="button" class="calendar-nav" id="prevMonth">&lt;</button>
                                        <span class="calendar-month-year" id="monthYear"></span>
                                        <button type="button" class="calendar-nav" id="nextMonth">&gt;</button>
                                    </div>
                                    <div class="calendar-days-header">
                                        <span>Dom</span>
                                        <span>Seg</span>
                                        <span>Ter</span>
                                        <span>Qua</span>
                                        <span>Qui</span>
                                        <span>Sex</span>
                                        <span>S√°b</span>
                                    </div>
                                    <div class="calendar-days" id="calendarDays"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cota√ß√£o USDT no Fechamento (R$) <span style="color:#888;">(opcional)</span></label>
                            <input type="number" id="historicalQuote" placeholder="Ex: 5.4523" step="0.0001" min="0.0001">
                            <small style="display:block; margin-top:0.35rem; color:#D4AF37;">Informe para ordem retroativa; se vazio, usa cota√ß√£o atual.</small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Produto / Servi√ßo <span>*</span></label>
                            <select id="productType" required onchange="toggleProductFields()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cliente <span>*</span></label>
                            <input type="text" id="clientName" placeholder="Nome do cliente" required>
                        </div>
                    </div>

                    <!-- USDT Fields -->
                    <div id="usdtFields" style="display: none;">
                        <h4 style="color: #D4AF37; margin: 2rem 0 1rem;">üí∞ Dados USDT</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Quantidade de USDT <span>*</span></label>
                                <input type="number" id="usdtQuantity" placeholder="Ex: 1000" step="0.01">
                            </div>
                        <div class="form-group">
                            <label>Pre√ßo Fechado por USDT (R$) <span>*</span></label>
                            <input type="number" id="usdtPrice" placeholder="Ex: 5.42" step="any" min="0.00001">
                            <small id="usdtQuoteLive" style="display: block; margin-top: 0.35rem; color: #D4AF37;">Cota√ß√£o: --</small>
                        </div>
                        <div class="form-group">
                            <label>Wallet <span>*</span></label>
                            <input type="text" id="usdtWallet" placeholder="Endere√ßo da wallet">
                        </div>
                        </div>
                        <div class="info-box">
                            <span class="info-box-icon">üí°</span>
                            <div class="info-box-text">
                                <strong>Custo:</strong> O custo ser√° calculado automaticamente pelo administrador com base na configura√ß√£o do sistema.
                            </div>
                        </div>
                    </div>

                    <!-- Remessa Fields -->
                    <div id="remessaFields" style="display: none;">
                        <h4 style="color: #D4AF37; margin: 2rem 0 1rem;">üåé Dados da Remessa</h4>
                        <div class="form-grid">
                        <div class="form-group">
                            <label>Valor da Remessa (USD) <span>*</span></label>
                            <input type="number" id="remessaQtd" placeholder="Ex: 1845.39" step="any" min="0.00001">
                            </div>
                        <div class="form-group">
                            <label>Cota√ß√£o D√≥lar Negociada <span>*</span></label>
                            <input type="number" id="remessaDolar" placeholder="Ex: 5.42" step="any" min="0.00001">
                        </div>
                        </div>
                        <div class="info-box">
                            <span class="info-box-icon">üí°</span>
                            <div class="info-box-text">
                                <strong>Custo:</strong> O custo ser√° calculado automaticamente pelo administrador com base na configura√ß√£o do sistema.
                            </div>
                        </div>
                    </div>

                    <!-- Comprovantes -->
                    <div class="form-group" style="margin-top: 2rem;">
                        <label>Comprovantes de Pagamento (at√© 4 arquivos) <span>*</span></label>
                        <input 
                            type="file" 
                            id="paymentProof" 
                            accept="image/*,application/pdf,.doc,.docx" 
                            multiple
                            style="padding: 0.75rem; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff; cursor: pointer;"
                        >
                        <div id="fileNames" style="margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;"></div>
                    </div>

                    <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="orderSubmitBtn">‚úÖ Enviar Ordem</button>
                    <button type="reset" class="btn btn-secondary" onclick="document.getElementById('fileName').textContent=''">üîÑ Limpar</button>
                </div>
            </form>
        </div>
        </div>

        <!-- Em An√°lise Section -->
        <div id="em-analise" class="content-section">
            <div class="form-card">
                <h3><span>‚è≥</span> Ordens em An√°lise</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Lan√ßamento</th>
                            <th>Status</th>
                            <th>Comprovante</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Conclu√≠das Section -->
        <div id="concluidas" class="content-section">
            <div class="form-card">
                <h3><span>‚úÖ</span> Ordens Conclu√≠das</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Lan√ßamento</th>
                            <th>Status</th>
                            <th>Comprovante</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="concludedTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Minhas Vendas Section -->
        <div id="minhas-vendas" class="content-section">
            <div class="form-card">
                <h3><span>üìã</span> Todas as Minhas Vendas</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Pre√ßo (un.)</th>
                            <th>Wallet</th>
                            <th>Venda</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Comiss√£o</th>
                            <th>Data</th>
                            <th>Lan√ßamento</th>
                            <th>Status</th>
                            <th>Comprovante</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="allSalesTbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Comprovante -->
    <div id="comprovanteModalGerente" class="modal-overlay" style="display: none;" onclick="fecharModalGerente()">
        <div class="modal-card modal-comprovante" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üìé Comprovante de Pagamento</h3>
                <button type="button" class="modal-close" onclick="fecharModalGerente()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="comprovante-info">
                    <p><strong>Wallet:</strong> <span id="walletInfoGerente">-</span></p>
                </div>
                <div class="comprovante-image-container">
                    <img id="comprovanteImgGerente" src="" alt="Comprovante" style="display: none;">
                    <p id="comprovantePlaceholderGerente" class="comprovante-placeholder">üìÑ Nenhum comprovante enviado</p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharModalGerente()">Fechar</button>
                <button type="button" class="btn btn-primary" id="openProofNewTabGerente" style="display: none;">üîó Abrir em nova guia</button>
            </div>
        </div>
    </div>

    <!-- Modal Upload Comprovante -->
    <div id="uploadProofModal" class="modal-overlay" style="display: none;" onclick="closeUploadProofModal()">
        <div class="modal-card" style="max-width: 500px;" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>üì§ Enviar Comprovante</h3>
                <button type="button" class="modal-close" onclick="closeUploadProofModal()">√ó</button>
            </div>
            <form id="uploadProofForm">
                <input type="hidden" id="uploadProofOrderId">
                <div class="form-group">
                    <label>Selecione o comprovante de pagamento <span>*</span></label>
                    <input 
                        type="file" 
                        id="uploadProofFile" 
                        accept="image/*,application/pdf,.doc,.docx" 
                        multiple
                        required 
                        style="padding: 0.75rem; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: #fff; cursor: pointer;">
                    <div id="uploadFileNames" style="margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;"></div>
                </div>
                <div class="info-box" style="margin-top: 1rem;">
                    <span class="info-box-icon">üí°</span>
                    <div class="info-box-text">
                        Formatos aceitos: JPG, PNG, PDF. Tamanho m√°ximo: 5MB.
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadProofModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üì§ Enviar Comprovante</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div id="profileModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:#0f0f14; border:1px solid #2a2a2a; border-radius:14px; padding:24px; width:95%; max-width:520px; box-shadow:0 20px 70px rgba(0,0,0,0.45); position:relative;">
            <button onclick="closeProfileModal()" style="position:absolute; top:10px; right:10px; background:#222; border:1px solid #333; color:#eee; width:32px; height:32px; border-radius:50%;">‚úï</button>
            <h3 style="color:#D4AF37; margin-top:0;">üë§ Perfil do Usu√°rio</h3>
            <form id="profileForm" style="display:grid; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div id="profileAvatarPreview" style="width:64px; height:64px; border-radius:50%; background:#D4AF37; color:#0a0a0a; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px;">?</div>
                    <label style="cursor:pointer; color:#D4AF37;">üì§ Trocar foto
                        <input type="file" id="profileImageInput" accept="image/*" style="display:none;">
                    </label>
                </div>
                <label>Nome<input type="text" id="profileName" required></label>
                <label>E-mail<input type="email" id="profileEmail" required></label>
                <label>Telefone<input type="tel" id="profilePhone"></label>
                <label>Nova senha (opcional)<input type="password" id="profilePassword" autocomplete="new-password"></label>
                <div style="display:flex; gap:12px; margin-top:8px;">
                    <button type="submit" class="btn btn-primary" style="flex:1;">üíæ Salvar</button>
                    <button type="button" class="btn btn-secondary" style="flex:1;" onclick="closeProfileModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const apiBase = '';
        let currentSellerId = null; // ser√° definido pelo login/usu√°rio encontrado
        let loggedUserId = null;
        let currentUser = null;
        let isSubmittingOrder = false;
        let assignedServices = [];
        let lastUsdtQuote = null;
        let cachedOrders = [];
        window.cachedOrders = cachedOrders;

        function getTodayIsoLocal() {
            const now = new Date();
            // corrige fuso para manter a data local no formato YYYY-MM-DD
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 10);
        }

        function formatIsoToBr(isoStr) {
            if (!isoStr || typeof isoStr !== 'string') return '';
            const [y, m, d] = isoStr.split('-');
            if (y?.length === 4 && m?.length === 2 && d?.length === 2) {
                return `${d}/${m}/${y}`;
            }
            return '';
        }

        function parseBrDateToIso(brStr) {
            if (!brStr || typeof brStr !== 'string') return '';
            const match = brStr.match(/^\s*(\d{2})[\/](\d{2})[\/](\d{4})\s*$/);
            if (!match) return '';
            const [, d, m, y] = match;
            return `${y}-${m}-${d}`;
        }

        function setOrderDateToday() {
            const dateInput = document.getElementById('orderDate');
            if (!dateInput) return;
            const iso = getTodayIsoLocal();
            dateInput.value = formatIsoToBr(iso);
        }

        function normalizeOrderDateInput() {
            const dateInput = document.getElementById('orderDate');
            if (!dateInput) return { iso: '', br: '' };
            const raw = (dateInput.value || '').trim();
            const iso = parseBrDateToIso(raw) || (/^\d{4}-\d{2}-\d{2}$/.test(raw) ? raw : '');
            if (iso) {
                dateInput.value = formatIsoToBr(iso);
            }
            return { iso, br: dateInput.value };
        }

        function showSection(event, sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        function toggleProductFields() {
            const productType = document.getElementById('productType').value;
            const usdtFields = document.getElementById('usdtFields');
            const remessaFields = document.getElementById('remessaFields');

            usdtFields.style.display = 'none';
            remessaFields.style.display = 'none';

            document.querySelectorAll('#usdtFields input, #remessaFields input').forEach(input => {
                input.removeAttribute('required');
            });

            const service = assignedServices.find(s => String(s.id) === String(productType));
            const name = service?.name?.toLowerCase() || '';
            if (name.includes('usdt')) {
                usdtFields.style.display = 'block';
                document.querySelectorAll('#usdtFields input').forEach(input => {
                    input.setAttribute('required', 'required');
                });
            } else if (name.includes('remessa')) {
                remessaFields.style.display = 'block';
                document.querySelectorAll('#remessaFields input').forEach(input => {
                    input.setAttribute('required', 'required');
                });
            }
        }

        function showFileName(input) {
            const fileNamesDiv = document.getElementById('fileNames');
            const files = Array.from(input.files || []);

            if (files.length > 0) {
                fileNamesDiv.innerHTML = files.map((f, i) => {
                    return `<div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                        <span style="color: #10b981;">‚úì</span>
                        <span>${i + 1}. ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>`;
                }).join('');
            } else {
                fileNamesDiv.innerHTML = '';
            }
        }

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }

        function openUploadProofModal(orderId) {
            const modal = document.getElementById('uploadProofModal');
            const orderIdInput = document.getElementById('uploadProofOrderId');
            const fileInput = document.getElementById('uploadProofFile');
            if (orderIdInput) orderIdInput.value = orderId;
            if (fileInput) fileInput.value = '';
            const namesDiv = document.getElementById('uploadFileNames');
            if (namesDiv) namesDiv.innerHTML = '';
            if (modal) modal.style.display = 'flex';
        }

        function closeUploadProofModal() {
            const modal = document.getElementById('uploadProofModal');
            const form = document.getElementById('uploadProofForm');
            if (form) form.reset();
            const namesDiv = document.getElementById('uploadFileNames');
            if (namesDiv) namesDiv.innerHTML = '';
            if (modal) modal.style.display = 'none';
        }

        document.getElementById('paymentProof')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const fileNamesDiv = document.getElementById('fileNames');
            
            if (files.length > 4) {
                alert('‚ö†Ô∏è M√°ximo de 4 arquivos permitidos');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            const validFormats = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const invalidFiles = files.filter(f => !validFormats.includes(f.type));
            
            if (invalidFiles.length > 0) {
                alert('‚ö†Ô∏è Formato inv√°lido. Aceitos: PDF, JPG, PNG, DOC, DOCX');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            const oversizedFiles = files.filter(f => f.size > 10 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                alert('‚ö†Ô∏è Arquivo(s) muito grande(s). M√°ximo: 10MB por arquivo');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            if (files.length > 0) {
                fileNamesDiv.innerHTML = files.map((f, i) => 
                    `<div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                        <span style="color: #10b981;">‚úì</span>
                        <span>${i + 1}. ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>`
                ).join('');
            } else {
                fileNamesDiv.innerHTML = '';
            }
        });

        document.getElementById('uploadProofFile')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const fileNamesDiv = document.getElementById('uploadFileNames');
            
            if (files.length > 4) {
                alert('‚ö†Ô∏è M√°ximo de 4 arquivos');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            const validFormats = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const invalidFiles = files.filter(f => !validFormats.includes(f.type));
            
            if (invalidFiles.length > 0) {
                alert('‚ö†Ô∏è Formato inv√°lido. Aceitos: PDF, JPG, PNG, DOC, DOCX');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            const oversizedFiles = files.filter(f => f.size > 10 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                alert('‚ö†Ô∏è Arquivo muito grande. M√°ximo: 10MB por arquivo');
                e.target.value = '';
                fileNamesDiv.innerHTML = '';
                return;
            }
            
            if (files.length > 0) {
                fileNamesDiv.innerHTML = files.map((f, i) => 
                    `<div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                        <span style="color: #10b981;">‚úì</span>
                        <span>${i + 1}. ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>`
                ).join('');
            } else {
                fileNamesDiv.innerHTML = '';
            }
        });

        document.getElementById('uploadProofForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const orderId = document.getElementById('uploadProofOrderId')?.value;
            const fileInput = document.getElementById('uploadProofFile');
            const files = fileInput?.files;
            if (!orderId) return;
            if (!files || files.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um arquivo');
                return;
            }
            if (files.length > 4) {
                alert('‚ö†Ô∏è M√°ximo de 4 arquivos');
                return;
            }

            try {
                // Buscar comprovantes existentes
                const existingOrder = cachedOrders.find(o => Number(o.id) === Number(orderId));
                let existingProofs = [];
                if (existingOrder?.payoutProof) {
                    try {
                        existingProofs = JSON.parse(existingOrder.payoutProof);
                        if (!Array.isArray(existingProofs)) existingProofs = [];
                    } catch {
                        existingProofs = [];
                    }
                }

                const newProofs = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`‚ö†Ô∏è Arquivo "${file.name}" muito grande. M√°x: 10MB`);
                        return;
                    }
                    const base64 = await readFileAsDataUrl(file);
                    newProofs.push({
                        name: file.name,
                        data: base64
                    });
                }

                const allProofs = [...existingProofs, ...newProofs].slice(0, 4);

                await fetchJson(`/api/orders/${orderId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ payoutProof: JSON.stringify(allProofs) })
                });
                alert('‚úÖ Comprovante enviado com sucesso!');
                closeUploadProofModal();
                await loadGerenteData();
            } catch (err) {
                showError(err);
            }
        });

        function verComprovanteGerente(id) {
            const modal = document.getElementById('comprovanteModalGerente');
            const order = cachedOrders.find(o => Number(o.id) === Number(id));
            if (!modal || !order) {
                alert('‚ö†Ô∏è Ordem n√£o encontrada');
                return;
            }
            
            const walletEl = document.getElementById('walletInfoGerente');
            const imgEl = document.getElementById('comprovanteImgGerente');
            const placeholderEl = document.getElementById('comprovantePlaceholderGerente');
            const openNewTabBtn = document.getElementById('openProofNewTabGerente');
            const containerEl = document.getElementById('comprovanteImgGerente')?.parentElement;
            
            if (walletEl) walletEl.textContent = order.wallet || '-';
            
            if (order.payoutProof && order.payoutProof.trim() !== '') {
                let proofs = [];
                try {
                    proofs = JSON.parse(order.payoutProof);
                    if (!Array.isArray(proofs)) proofs = [proofs];
                } catch {
                    proofs = [order.payoutProof];
                }

                const normalizedProofs = proofs.map((p, i) => {
                    if (typeof p === 'string') {
                        return { name: `Comprovante ${i + 1}`, data: p };
                    }
                    if (p && typeof p === 'object') {
                        return { name: p.name || `Comprovante ${i + 1}`, data: p.data || p.url || '' };
                    }
                    return { name: `Comprovante ${i + 1}`, data: '' };
                }).filter(p => p.data);
                
                if (containerEl) {
                    containerEl.innerHTML = normalizedProofs.map((proof, i) => {
                        const dataStr = proof.data || '';
                        const isPdf = dataStr.includes('application/pdf');
                        const isDoc = dataStr.includes('application/msword') || dataStr.includes('application/vnd.openxmlformats');
                        
                        if (isPdf || isDoc) {
                            return `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 2rem;">${isPdf ? 'üìÑ' : 'üìù'}</span>
                                <div>
                                    <div style="font-weight: 600; color: #D4AF37;">${proof.name || `Comprovante ${i + 1}`}</div>
                                    <a href="${dataStr}" download="${proof.name || `comprovante-${i + 1}`}" 
                                       style="color: #3b82f6; text-decoration: underline; font-size: 0.85rem;">
                                        üì• Baixar arquivo
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                        } else {
                            return `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #D4AF37; margin-bottom: 0.5rem;">${proof.name || `Comprovante ${i + 1}`}</div>
                            <img src="${dataStr}" alt="Comprovante ${i + 1}" 
                                 style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #333;">
                        </div>
                    `;
                        }
                    }).join('');
                }
                
                if (placeholderEl) placeholderEl.style.display = 'none';
                if (openNewTabBtn) openNewTabBtn.style.display = 'none';
            } else {
                if (imgEl) {
                    imgEl.style.display = 'none';
                    imgEl.src = '';
                }
                if (containerEl) containerEl.innerHTML = '<img id="comprovanteImgGerente" src="" alt="Comprovante" style="display: none;">';
                if (placeholderEl) placeholderEl.style.display = 'block';
                if (openNewTabBtn) openNewTabBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        function fecharModalGerente() {
            const modal = document.getElementById('comprovanteModalGerente');
            if (modal) modal.style.display = 'none';
            currentComprovanteUrlGerente = null;
        }

        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isSubmittingOrder) return;

            const productType = document.getElementById('productType').value;
            const selectedService = assignedServices.find(s => String(s.id) === String(productType));
            const clientName = document.getElementById('clientName').value;
            const todayStr = getTodayIsoLocal();
            const { iso: parsedIso } = normalizeOrderDateInput();
            const orderDate = parsedIso || todayStr;
            const historicalQuote = Number(document.getElementById('historicalQuote').value || 0);
            const fileInput = document.getElementById('paymentProof');
            const usdtQuantity = Number(document.getElementById('usdtQuantity').value || 0);
            const usdtPrice = Number(document.getElementById('usdtPrice').value || 0);
            const remessaQtd = Number(document.getElementById('remessaQtd').value || 0);
            const remessaDolar = Number(document.getElementById('remessaDolar').value || 0);
            const wallet = document.getElementById('usdtWallet').value || null;
            const isRemessa = (selectedService?.name || '').trim().toLowerCase() === 'remessa';
            const isRetroactive = orderDate !== todayStr;

            let priceBRL = 0;
            if (selectedService?.name?.toLowerCase().includes('usdt')) {
                priceBRL = usdtQuantity * usdtPrice;
            } else if (selectedService?.name?.toLowerCase().includes('remessa')) {
                priceBRL = remessaQtd * remessaDolar;
            }

            const payload = {
                customer: clientName,
                sellerId: currentSellerId,
                serviceId: selectedService?.id || null,
                quantity: remessaQtd || usdtQuantity || 0,
                unitPrice: isRemessa ? remessaDolar : usdtPrice,
                price: priceBRL,
                historicalQuote: historicalQuote || null,
                isRetroactive,
                cost: 0,
                status: 'open',
                date: orderDate,
                productType: selectedService?.name || 'Servi√ßo',
                wallet
            };

            const submitBtn = document.getElementById('orderSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
            }
            isSubmittingOrder = true;

            try {
                if (fileInput.files.length > 0) {
                    const proofArray = [];
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const file = fileInput.files[i];
                        const base64 = await readFileAsDataUrl(file);
                        proofArray.push({
                            name: file.name,
                            data: base64
                        });
                    }
                    payload.payoutProof = JSON.stringify(proofArray);
                }

                await fetchJson('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                alert(`‚úÖ Ordem criada com sucesso!\n\nCliente: ${clientName}\nProduto: ${productType.toUpperCase()}\nStatus: Em An√°lise\n\nAguarde a aprova√ß√£o do administrador.`);
                this.reset();
                document.getElementById('fileNames').innerHTML = '';
                document.getElementById('usdtFields').style.display = 'none';
                document.getElementById('remessaFields').style.display = 'none';
                setOrderDateToday();
                const histInput = document.getElementById('historicalQuote');
                if (histInput) histInput.value = '';
                await loadGerenteData();
            } catch (err) {
                showError(err);
            } finally {
                isSubmittingOrder = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üü¢ Enviar para An√°lise';
                }
            }
        });

        async function atualizarCotacaoGerente() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL');
                const data = await response.json();

                if (data && data.price) {
                    const priceNum = parseFloat(data.price);
                    const price = priceNum.toFixed(4);
                    const priceFormatted = 'R$ ' + price.replace('.', ',');
                    document.getElementById('usdtPriceGerente').textContent = priceFormatted;
                    document.getElementById('topUsdtPrice').textContent = priceFormatted;
                    const live = document.getElementById('usdtQuoteLive');
                    // custo com spread 0,30%
                    const spreadPercent = 0.30;
                    const costWithSpread = priceNum * (1 + (spreadPercent / 100));
                    const costFormatted = 'R$ ' + costWithSpread.toFixed(4).replace('.', ',');
                    if (live) live.textContent = `Cota√ß√£o: ${priceFormatted} ‚Ä¢ c/ spread 0,30%: ${costFormatted}`;
                    lastUsdtQuote = Number(price);

                    const costEl = document.getElementById('usdtCostPrice');
                    if (costEl) costEl.textContent = costFormatted;

                    console.log('Cota√ß√£o USDT atualizada (Gerente):', price);
                }
            } catch (error) {
                console.error('Erro ao buscar cota√ß√£o:', error);
                const costEl = document.getElementById('usdtCostPrice');
                if (costEl) costEl.textContent = 'R$ --';
            }
        }

        window.addEventListener('load', function() {
            atualizarCotacaoGerente();
            setInterval(atualizarCotacaoGerente, 30000);
            setOrderDateToday();
            normalizeOrderDateInput();
            loadGerenteData();
            setupUserMenu();
            restoreProfileImage();
        });

        // Calend√°rio Dropdown Customizado
        (function() {
            let selectedDate = null;
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();

            const orderDateInput = document.getElementById('orderDate');
            const calendarToggle = document.getElementById('calendarToggle');
            const calendarDropdown = document.getElementById('calendarDropdown');
            const monthYearDisplay = document.getElementById('monthYear');
            const calendarDaysContainer = document.getElementById('calendarDays');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');

            if (!orderDateInput || !calendarToggle || !calendarDropdown) return;

            const months = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            calendarToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = calendarDropdown.style.display === 'block';
                calendarDropdown.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) renderCalendar();
            });

            orderDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                calendarDropdown.style.display = 'block';
                renderCalendar();
            });

            document.addEventListener('click', function(e) {
                if (!calendarDropdown.contains(e.target) &&
                    e.target !== calendarToggle &&
                    e.target !== orderDateInput) {
                    calendarDropdown.style.display = 'none';
                }
            });

            prevMonthBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            function renderCalendar() {
                monthYearDisplay.textContent = `${months[currentMonth]} ${currentYear}`;
                calendarDaysContainer.innerHTML = '';

                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const dayBtn = createDayButton(day, true, currentMonth - 1, currentYear);
                    calendarDaysContainer.appendChild(dayBtn);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayBtn = createDayButton(day, false, currentMonth, currentYear);
                    calendarDaysContainer.appendChild(dayBtn);
                }

                const totalCells = calendarDaysContainer.children.length;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                for (let day = 1; day <= remainingCells; day++) {
                    const dayBtn = createDayButton(day, true, currentMonth + 1, currentYear);
                    calendarDaysContainer.appendChild(dayBtn);
                }
            }

            function createDayButton(day, isOtherMonth, month, year) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'calendar-day';
                btn.textContent = day;

                const btnDate = new Date(year, month, day);
                btnDate.setHours(0, 0, 0, 0);

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (isOtherMonth) btn.classList.add('other-month');
                if (btnDate.getTime() === today.getTime() && !isOtherMonth) btn.classList.add('today');

                if (btnDate > today) {
                    btn.classList.add('disabled');
                    btn.disabled = true;
                }

                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                oneYearAgo.setHours(0, 0, 0, 0);
                if (btnDate < oneYearAgo) {
                    btn.classList.add('disabled');
                    btn.disabled = true;
                }

                if (selectedDate && btnDate.getTime() === selectedDate.getTime() && !isOtherMonth) {
                    btn.classList.add('selected');
                }

                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!btn.disabled) selectDate(btnDate);
                });

                return btn;
            }

            function selectDate(date) {
                selectedDate = date;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                orderDateInput.value = `${day}/${month}/${year}`;
                calendarDropdown.style.display = 'none';
                orderDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Verificar se √© retroativa e mostrar aviso din√¢mico
                const selectedDateObj = new Date(year, month - 1, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDateObj.setHours(0, 0, 0, 0);
                
                let warningEl = document.getElementById('retroWarningDynamic');
                
                if (selectedDateObj < today) {
                    // Data √© anterior a hoje - mostrar aviso
                    if (!warningEl) {
                        warningEl = document.createElement('div');
                        warningEl.id = 'retroWarningDynamic';
                        warningEl.className = 'info-box';
                        warningEl.style.marginTop = '0.75rem';
                        warningEl.style.background = 'rgba(251, 191, 36, 0.1)';
                        warningEl.style.border = '1px solid rgba(251, 191, 36, 0.3)';
                        warningEl.innerHTML = `
                <span class="info-box-icon">‚ö†Ô∏è</span>
                <div class="info-box-text">
                    Esta ordem ser√° marcada como <strong>RETROATIVA</strong> pois a data √© anterior a hoje.
                </div>
            `;
                        const datePickerWrapper = document.querySelector('.date-picker-wrapper');
                        if (datePickerWrapper && datePickerWrapper.parentElement) {
                            datePickerWrapper.parentElement.appendChild(warningEl);
                        }
                    }
                } else {
                    // Data √© hoje ou futura - remover aviso
                    if (warningEl) {
                        warningEl.remove();
                    }
                }
            }

            selectDate(new Date());
            renderCalendar();
        })();

        function showError(err) {
            console.error(err);
            alert('‚ö†Ô∏è Erro: ' + (err?.message || 'n√£o foi poss√≠vel completar a a√ß√£o'));
        }

        async function fetchJson(path, options = {}) {
            const res = await fetch(apiBase + path, {
                credentials: 'include',
                ...options,
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) }
            });
            if (res.status === 401) {
                localStorage.removeItem('loggedLogin');
                window.location.href = '/login-gerente.html';
                return;
            }
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || res.statusText);
            }
            return res.status === 204 ? null : res.json();
        }

        function formatBRL(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatBRL4(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4, maximumFractionDigits: 4 });
        }

        function formatOrderDate(value) {
            if (!value) return '--';
            if (typeof value === 'string') {
                const match = value.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (match) {
                    const [, y, m, d] = match;
                    return `${d}/${m}/${y}`;
                }
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '--';
            return new Intl.DateTimeFormat('pt-BR', { timeZone: 'UTC' }).format(date);
        }

        function formatLaunchDate(order = {}) {
            return formatOrderDate(order.launchDate || order.launchdate || order.created_at || order.createdAt || null);
        }

        function renderOrdersForSeller(orders, users) {
            if (!currentSellerId && users.length) {
                currentSellerId = users[0].id;
            }
            const sellerOrders = currentSellerId
                ? orders.filter(o => Number(o.sellerId) === Number(currentSellerId))
                : [];
            const analysisTbody = document.getElementById('analysisTbody');
            const concludedTbody = document.getElementById('concludedTbody');
            const allSalesTbody = document.getElementById('allSalesTbody');
            if (analysisTbody) analysisTbody.innerHTML = '';
            if (concludedTbody) concludedTbody.innerHTML = '';
            if (allSalesTbody) allSalesTbody.innerHTML = '';

            // KPIs
            updateGerenteDashboard(sellerOrders, currentSellerId);

            sellerOrders.forEach(order => {
                const statusLabel = order.status === 'concluded' ? '<span class=\"badge badge-success\">Aprovada</span>' : '<span class=\"badge badge-pending\">Em An√°lise</span>';
                const unitPriceDisplay = Number(order.unitPrice) || (order.price && order.quantity ? Number(order.price) / Number(order.quantity) : null);
                const quantityDisplay = order.quantity != null ? order.quantity : '-';
                const walletDisplay = order.wallet ? `<span title=\"${order.wallet}\">${order.wallet}</span>` : '-';
                const retroBadge = order.isRetroactive ? '<span class=\"badge\" style=\"background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); font-size: 0.65rem;\">üìÖ RETRO</span>' : '';
                const dateTitle = order.historicalQuote ? ` title=\"Cota√ß√£o hist√≥rica: R$ ${Number(order.historicalQuote).toFixed(4)}\"` : ' title=\"Cota√ß√£o autom√°tica\"';
                const proofButton = order.payoutProof
                    ? `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"verComprovanteGerente(${order.id})\">üìé Ver</button>`
                    : '<span style=\"color: #888;\">-</span>';
                const baseRow = `
                    <td>#${order.id}${retroBadge ? ' ' + retroBadge : ''}</td>
                    <td>${order.customer || '-'}</td>
                    <td><span class=\"badge badge-gold\">${order.productType || 'Servi√ßo'}</span></td>
                    <td>${quantityDisplay}</td>
                    <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                    <td>${walletDisplay}</td>
                    <td>${formatBRL(order.price)}</td>
                    <td>${formatBRL(order.cost)}</td>
                    <td class=\"profit-value\">${order.profit != null ? formatBRL(order.profit) : '-'}</td>
                    <td class=\"profit-value\">${order.commissionValue != null ? formatBRL(order.commissionValue) : '-'}</td>
                    <td${dateTitle}>${formatOrderDate(order.date || Date.now())}</td>
                    <td>${formatLaunchDate(order)}</td>
                    <td>${statusLabel}</td>
                    <td>${proofButton}</td>
                    <td><button class=\"btn btn-secondary\" style=\"padding: 0.25rem 0.75rem; font-size: 0.85rem;\" onclick=\"deleteOrder(${order.id})\">üóëÔ∏è</button></td>
                `;

                const trAll = document.createElement('tr');
                trAll.innerHTML = baseRow;
                allSalesTbody?.appendChild(trAll);

                if (order.status === 'open') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${order.id}${retroBadge ? ' ' + retroBadge : ''}</td>
                        <td>${order.customer || '-'}</td>
                        <td><span class=\"badge badge-gold\">${order.productType || 'Servi√ßo'}</span></td>
                        <td>${quantityDisplay}</td>
                        <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                        <td>${walletDisplay}</td>
                        <td>${formatBRL(order.price)}</td>
                        <td>${formatBRL(order.cost)}</td>
                        <td class=\"profit-value\">${order.profit != null ? formatBRL(order.profit) : '-'}</td>
                        <td class=\"profit-value\">${order.commissionValue != null ? formatBRL(order.commissionValue) : '-'}</td>
                        <td${dateTitle}>${formatOrderDate(order.date || Date.now())}</td>
                        <td>${formatLaunchDate(order)}</td>
                        <td><span class=\"badge badge-pending\">Em An√°lise</span></td>
                        <td>${order.payoutProof 
                            ? `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"verComprovanteGerente(${order.id})\">üìé Ver</button>`
                            : `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"openUploadProofModal(${order.id})\">üì§ Enviar</button>`
                        }</td>
                        <td><button class=\"btn btn-secondary\" style=\"padding: 0.25rem 0.75rem; font-size: 0.85rem;\" onclick=\"deleteOrder(${order.id})\">üóëÔ∏è</button></td>
                `;
                    analysisTbody?.appendChild(tr);
                }

                if (order.status === 'concluded') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${order.id}${retroBadge ? ' ' + retroBadge : ''}</td>
                        <td>${order.customer || '-'}</td>
                        <td><span class=\"badge badge-gold\">${order.productType || 'Servi√ßo'}</span></td>
                        <td>${quantityDisplay}</td>
                        <td>${unitPriceDisplay != null ? formatBRL4(unitPriceDisplay) : '-'}</td>
                        <td>${walletDisplay}</td>
                        <td>${formatBRL(order.price)}</td>
                        <td>${formatBRL(order.cost)}</td>
                        <td class=\"profit-value\">${order.profit != null ? formatBRL(order.profit) : '-'}</td>
                        <td class=\"profit-value\">${order.commissionValue != null ? formatBRL(order.commissionValue) : '-'}</td>
                        <td${dateTitle}>${formatOrderDate(order.date || Date.now())}</td>
                        <td>${formatLaunchDate(order)}</td>
                        <td><span class=\"badge badge-success\">Aprovada</span></td>
                        <td>${order.payoutProof 
                            ? `<button class=\"btn btn-secondary\" style=\"padding: 0.35rem 0.75rem; font-size: 0.85rem;\" onclick=\"verComprovanteGerente(${order.id})\">üìé Ver</button>`
                            : '<span style=\"color: #888;\">-</span>'
                        }</td>
                        <td><button class=\"btn btn-secondary\" style=\"padding: 0.25rem 0.75rem; font-size: 0.85rem;\" onclick=\"deleteOrder(${order.id})\">üóëÔ∏è</button></td>
                    `;
                    concludedTbody?.appendChild(tr);
                }
            });
        }

        async function deleteOrder(id) {
            if (!confirm('Deseja excluir esta ordem?')) return;
            try {
                await fetchJson(`/api/orders/${id}`, { method: 'DELETE' });
                await loadGerenteData();
            } catch (err) {
                showError(err);
            }
        }

        async function loadGerenteData() {
            try {
                const results = await Promise.allSettled([
                    fetchJson('/api/users'),
                    fetchJson('/api/orders'),
                    fetchJson('/api/assignments')
                ]);
                const users = results[0].status === 'fulfilled' ? results[0].value : [];
                const orders = results[1].status === 'fulfilled' ? results[1].value : [];
                const assignments = results[2].status === 'fulfilled' ? results[2].value : [];

                cachedOrders = orders;
                window.cachedOrders = orders;
                resolveSellerId(users);
                assignedServices = assignments
                    .filter(a => Number(a.userId ?? a.userid) === Number(currentSellerId))
                    .map(a => ({
                        id: a.serviceId ?? a.serviceid,
                        name: a.serviceName || a.servicename
                    }))
                    .filter(svc => svc.id);
                populateProductTypes();
                renderOrdersForSeller(orders, users);
                updateGerenteDashboard(orders, currentSellerId);
            } catch (err) {
                showError(err);
            }
        }

        function populateProductTypes() {
            const select = document.getElementById('productType');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione...</option>';
            if (!assignedServices.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Nenhum servi√ßo atribu√≠do';
                select.appendChild(opt);
                select.disabled = true;
            } else {
                select.disabled = false;
                assignedServices.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });
            }
            toggleProductFields();
        }

        function updateGerenteDashboard(orders, currentUserId) {
            if (!orders || !currentUserId) return;
            const myOrders = orders.filter(o => Number(o.sellerId) === Number(currentUserId));
            const concludedOrders = myOrders.filter(o => (o.status || 'open') === 'concluded');
            const openOrders = myOrders.filter(o => (o.status || 'open') === 'open');

            const totalCommission = concludedOrders
                .filter(o => !o.commissionPaid)
                .reduce((acc, o) => acc + (Number(o.commissionValue ?? o.commissionvalue) || 0), 0);
            const totalProfit = concludedOrders.reduce((acc, o) => acc + (Number(o.profit) || 0), 0);
            const totalSales = concludedOrders.length;

            const bannerCommissionEl = document.getElementById('bannerCommission');
            const bannerProfitEl = document.getElementById('bannerProfit');
            const bannerSalesEl = document.getElementById('bannerSales');
            if (bannerCommissionEl) bannerCommissionEl.textContent = formatBRL(totalCommission);
            if (bannerProfitEl) bannerProfitEl.textContent = formatBRL(totalProfit);
            if (bannerSalesEl) bannerSalesEl.textContent = `${totalSales} ${totalSales === 1 ? 'venda' : 'vendas'}`;

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            const vendasMes = myOrders.filter(o => {
                const orderDate = new Date(o.date || o.created_at);
                return orderDate >= startOfMonth && orderDate <= endOfMonth;
            }).length;

            const vendasMesEl = document.getElementById('vendasMes');
            const vendasMesSubtitleEl = document.getElementById('vendasMesSubtitle');
            if (vendasMesEl) vendasMesEl.textContent = vendasMes.toString();
            if (vendasMesSubtitleEl) {
                const monthName = now.toLocaleDateString('pt-BR', { month: 'long' });
                vendasMesSubtitleEl.textContent = `Em ${monthName}`;
            }

            const totalValue = concludedOrders.reduce((acc, o) => acc + (Number(o.price) || 0), 0);
            const ticketMedio = concludedOrders.length > 0 ? totalValue / concludedOrders.length : 0;
            const ticketMedioEl = document.getElementById('ticketMedio');
            if (ticketMedioEl) ticketMedioEl.textContent = formatBRL(ticketMedio);

            const emAnaliseEl = document.getElementById('emAnalise');
            if (emAnaliseEl) emAnaliseEl.textContent = openOrders.length.toString();

            const totalOrdens = myOrders.length;
            const ordensAprovadas = concludedOrders.length;
            const taxaAprovacao = totalOrdens > 0 ? (ordensAprovadas / totalOrdens) * 100 : 0;

            const taxaAprovacaoEl = document.getElementById('taxaAprovacao');
            const taxaAprovacaoSubEl = document.getElementById('taxaAprovacaoSub');
            if (taxaAprovacaoEl) taxaAprovacaoEl.textContent = taxaAprovacao.toFixed(1) + '%';
            if (taxaAprovacaoSubEl) taxaAprovacaoSubEl.textContent = `${ordensAprovadas} ${ordensAprovadas === 1 ? 'aprovada' : 'aprovadas'}`;

            // Atualiza info do usu√°rio no banner se dispon√≠vel
            const user = currentUser;
            const name = user?.name || 'Usu√°rio';
            const role = user?.role || 'Gerente';
            const commissionRate = user?.commission != null ? `${user.commission}% comiss√£o` : '';
            const initials = name.split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase();
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            const userAvatarEl = document.getElementById('userAvatar');
            if (userNameEl) userNameEl.textContent = name;
            if (userRoleEl) userRoleEl.textContent = `${role}${commissionRate ? ' ‚Ä¢ ' + commissionRate : ''}`;
            if (userAvatarEl) userAvatarEl.textContent = initials;
            restoreProfileImage();
        }

        function resolveSellerId(users) {
            const storedLogin = (localStorage.getItem('loggedLogin') || '').toLowerCase();
            if (storedLogin) {
                const found = users.find(u =>
                    (u.email || '').toLowerCase() === storedLogin ||
                    (u.name || '').toLowerCase() === storedLogin ||
                    (u.login || '').toLowerCase() === storedLogin
                );
                if (found) {
                    currentSellerId = found.id;
                    currentUser = found;
                    loggedUserId = found.id;
                    return;
                }
            }
            if (!currentSellerId && users.length) {
                currentSellerId = users[0].id;
                currentUser = users[0];
                loggedUserId = users[0].id;
            }
        }

        // --- Perfil / Menu ---
        function setupUserMenu() {
            const trigger = document.getElementById('userMenuTrigger');
            const menu = document.getElementById('userMenu');
            if (!trigger || !menu) return;
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', () => {
                menu.style.display = 'none';
            });
        }

        function openProfileModal() {
            if (!currentUser) {
                alert('Usu√°rio n√£o identificado.');
                return;
            }
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profilePassword').value = '';
            updateProfileAvatarPreview(currentUser);
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function logout() {
            fetch('/api/logout', { method: 'POST', credentials: 'include' }).catch(() => {});
            localStorage.removeItem('loggedLogin');
            window.location.href = '/login-gerente.html';
        }

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser) return alert('Usu√°rio n√£o identificado.');
            const payload = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                role: currentUser.role,
                commission: currentUser.commission,
                status: currentUser.status
            };
            const newPassword = document.getElementById('profilePassword').value;
            try {
                await fetchJson(`/api/users/${currentUser.id}`, { method: 'PUT', body: JSON.stringify(payload) });
                await fetchJson(`/api/users/${currentUser.id}/credentials`, { method: 'PATCH', body: JSON.stringify({ email: payload.email, password: newPassword, role: payload.role }) });
                if (payload.email) localStorage.setItem('loggedLogin', payload.email);
                saveProfileImage();
                alert('‚úÖ Perfil atualizado!');
                closeProfileModal();
                loadGerenteData();
            } catch (err) {
                showError(err);
            }
        });

        document.getElementById('profileImageInput').addEventListener('change', handleProfileImage);

        function handleProfileImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                setAvatarImages(dataUrl);
                if (currentUser?.id) {
                    localStorage.setItem(`profile_img_${currentUser.id}`, dataUrl);
                }
            };
            reader.readAsDataURL(file);
        }

        function restoreProfileImage() {
            if (!currentUser?.id) return;
            const dataUrl = localStorage.getItem(`profile_img_${currentUser.id}`);
            if (dataUrl) {
                setAvatarImages(dataUrl);
            } else {
                setAvatarInitials(currentUser);
            }
        }

        function setAvatarImages(dataUrl) {
            const avatar = document.getElementById('userAvatar');
            const preview = document.getElementById('profileAvatarPreview');
            [avatar, preview].forEach(el => {
                if (el) {
                    el.style.backgroundImage = `url(${dataUrl})`;
                    el.style.backgroundSize = 'cover';
                    el.textContent = '';
                }
            });
        }

        function setAvatarInitials(user) {
            const initials = (user?.name || '?').split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase();
            const avatar = document.getElementById('userAvatar');
            const preview = document.getElementById('profileAvatarPreview');
            [avatar, preview].forEach(el => {
                if (el) {
                    el.style.backgroundImage = '';
                    el.textContent = initials;
                }
            });
        }

        function updateProfileAvatarPreview(user) {
            const dataUrl = localStorage.getItem(`profile_img_${user.id}`);
            if (dataUrl) {
                setAvatarImages(dataUrl);
            } else {
                setAvatarInitials(user);
            }
        }

        function saveProfileImage() {
            restoreProfileImage();
        }
    </script>
</body>
</html>
